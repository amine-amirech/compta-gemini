<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G√©n√©rateur √âcritures Comptables N2F/Sage</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-xl shadow-xl p-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">G√©n√©rateur d'√©critures comptables N2F / Sage</h1>
      <p class="text-gray-600 mb-8">Importez une facture PDF et g√©n√©rez automatiquement l'√©criture comptable</p>
      
      <!-- Configuration API Gemini -->
      <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div class="ml-3 flex-1">
            <p class="text-sm text-yellow-700 font-semibold mb-2">‚öôÔ∏è Configuration requise</p>
            <div class="flex gap-2">
              <input type="password" id="apiKey" placeholder="Votre API ici" class="flex-1 px-3 py-2 border rounded-lg text-sm">
              <button onclick="saveApiKey()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm whitespace-nowrap">
                üíæ Sauvegarder
              </button>
              <a href="https://aistudio.google.com/app/apikey" target="_blank" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm whitespace-nowrap">
                üîë Obtenir cl√©
              </a>
            </div>
            <p class="text-xs text-yellow-600 mt-2">üìå La cl√© est stock√©e localement dans votre navigateur</p>
          </div>
        </div>
      </div>

      <div class="bg-blue-50 rounded-lg p-6 mb-6 border border-blue-200">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Param√®tres</h2>
        <div class="mb-4">
  <label class="block text-sm font-medium text-gray-700 mb-2">Code journal</label>
  <input type="text" id="codeJournal" value="HA" maxlength="2" class="w-full px-3 py-2 border rounded-lg">
</div>
        
        <div class="flex gap-2">
          <button onclick="openAccountManager('charge')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm">
            G√©rer Comptes Charges
          </button>
          <button onclick="openAccountManager('fournisseur')" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm">
            G√©rer Comptes Fournisseurs
          </button>
          <button onclick="openAccountManager('tva')" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 text-sm">
            G√©rer Comptes TVA
          </button>
        </div>
      </div>

      <div class="mb-8">
        <label id="dropZone" class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-blue-300 rounded-lg cursor-pointer bg-blue-50 hover:bg-blue-100">
          <div class="text-center">
            <p class="mb-2 text-sm text-gray-700"><span class="font-semibold">Cliquez</span> ou glissez un PDF</p>
            <p id="fileName" class="text-xs text-gray-500"></p>
          </div>
          <input type="file" id="fileInput" accept="application/pdf" class="hidden" multiple>
        </label>
      </div>

      

     <div id="filesList" class="hidden mb-6">
  <h3 class="font-semibold text-gray-800 mb-2">Fichiers s√©lectionn√©s :</h3>
  <div id="filesListContent" class="space-y-2"></div>
  <button onclick="processAllFiles()" class="mt-4 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">
    üìä Traiter toutes les factures
  </button>
</div>

<div id="loading" class="hidden text-center py-8">
  <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
  <p class="mt-4 text-gray-600">Analyse en cours...</p>
  <p id="progressText" class="text-sm text-gray-500 mt-2"></p>
</div>

<div id="results" class="hidden space-y-4">
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
          <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-800">√âcritures comptables des factures trait√©es</h2>
            <button id="mainExportBtn" onclick="confirmAndExportBatch()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold transition-colors flex items-center gap-2">
              <span>üíæ</span> Exporter tout vers Sage (.txt)
            </button>
          </div>
          
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">N¬∞ Facture</th>
                  <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Date</th>
                  <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Fournisseur</th>
                  <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Libell√© / R√©f. PDR (Modifiable)</th>
                  <th class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase">HT</th>
                  <th class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase">TVA</th>
                  <th class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase">TTC</th>
                  <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase">Type</th>
                  <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody id="batchBody" class="bg-white divide-y divide-gray-200 text-sm">
                </tbody>
            </table>
          </div>
        </div>
        
        <div class="flex justify-end">
          <button onclick="resetBatch()" class="text-gray-500 hover:text-red-600 text-sm font-medium flex items-center gap-1">
            <span>üîÑ</span> R√©initialiser la session
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Gestion Comptes -->
  <div id="accountModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
      <h2 id="modalTitle" class="text-2xl font-bold mb-4"></h2>
      
      <div class="mb-4">
        <h3 class="font-semibold mb-2">Ajouter un compte</h3>
        <div class="flex gap-2">
          <input type="text" id="newAccountCode" placeholder="Code (ex: 606110)" class="flex-1 px-3 py-2 border rounded-lg">
          <input type="text" id="newAccountLabel" placeholder="Libell√©" class="flex-1 px-3 py-2 border rounded-lg">
          <button onclick="addNewAccount()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
            Ajouter
          </button>
        </div>
      </div>

      <div class="mb-4">
        <h3 class="font-semibold mb-2">Comptes existants</h3>
        <div id="accountsList" class="space-y-2"></div>
      </div>

      <button onclick="closeAccountManager()" class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
        Fermer
      </button>
    </div>
  </div>

  <script>
    let extractedData = null;
    let accountEntries = [];
    let currentAccountType = null;
    let selectedFiles = [];

    // üÜï FONCTIONS DE GESTION DES COMPTES
    function openAccountManager(type) {
      currentAccountType = type;
      const modal = document.getElementById('accountModal');
      const title = document.getElementById('modalTitle');
      
      const titles = {
        'charge': 'üíº Gestion des Comptes de Charges',
        'fournisseur': 'üè¢ Gestion des Comptes Fournisseurs',
        'tva': 'üìä Gestion des Comptes TVA'
      };
      
      title.textContent = titles[type] || 'Gestion des comptes';
      displayAccountsList();
      modal.classList.remove('hidden');
    }
    
    function closeAccountManager() {
      document.getElementById('accountModal').classList.add('hidden');
      currentAccountType = null;
      document.getElementById('newAccountCode').value = '';
      document.getElementById('newAccountLabel').value = '';
    }
    
    function displayAccountsList() {
      const listDiv = document.getElementById('accountsList');
      let accounts = [];
      
      if (currentAccountType === 'charge') accounts = comptesCharges;
      else if (currentAccountType === 'fournisseur') accounts = comptesFournisseurs;
      else if (currentAccountType === 'tva') accounts = comptesTVA;
      
      listDiv.innerHTML = accounts.map((acc, idx) => `
        <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
          <div class="flex-1">
            <span class="font-mono font-semibold text-sm">${acc.code}</span>
            <span class="text-gray-600 text-sm ml-3">${acc.label}</span>
          </div>
          <button onclick="deleteAccount(${idx})" class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs">
            üóëÔ∏è
          </button>
        </div>
      `).join('');
    }
    
    function addNewAccount() {
      const code = document.getElementById('newAccountCode').value.trim();
      const label = document.getElementById('newAccountLabel').value.trim();
      
      if (!code || !label) {
        alert('‚ö†Ô∏è Veuillez renseigner le code et le libell√©');
        return;
      }
      
      if (currentAccountType === 'charge') {
        comptesCharges.push({ code, label });
        comptesCharges.sort((a, b) => a.code.localeCompare(b.code));
      } else if (currentAccountType === 'fournisseur') {
        comptesFournisseurs.push({ code, label });
        comptesFournisseurs.sort((a, b) => a.code.localeCompare(b.code));
      } else if (currentAccountType === 'tva') {
        comptesTVA.push({ code, label });
      }
      
      document.getElementById('newAccountCode').value = '';
      document.getElementById('newAccountLabel').value = '';
      displayAccountsList();
      alert('‚úÖ Compte ajout√© avec succ√®s');
    }
    
    function deleteAccount(index) {
      if (!confirm('‚ö†Ô∏è Supprimer ce compte ?')) return;
      
      if (currentAccountType === 'charge') {
        comptesCharges.splice(index, 1);
      } else if (currentAccountType === 'fournisseur') {
        comptesFournisseurs.splice(index, 1);
      } else if (currentAccountType === 'tva') {
        comptesTVA.splice(index, 1);
      }
      
      displayAccountsList();
      alert('‚úÖ Compte supprim√©');
    }
    
    function getAccountsByType(type) {
      if (type === 'charge') return comptesCharges;
      if (type === 'fournisseur') return comptesFournisseurs;
      if (type === 'tva') return comptesTVA;
      return [];
    }
    
function updateAccount(index, compte) {
      accountEntries[index].compte = compte;
      console.log(`Compte ${index} mis √† jour:`, compte);
    }
    
    // üÜï FONCTION AVEC RAFRAICHISSEMENT VISUEL
    function updateAccountAndRefresh(index, compte) {
      accountEntries[index].compte = compte;
      
      // Rafra√Æchir visuellement le select
      const selectElement = document.getElementById(`account-select-${index}`);
      if (selectElement) {
        if (compte) {
          selectElement.classList.remove('border-red-300', 'bg-red-50');
          selectElement.classList.add('border-green-300', 'bg-green-50');
          
          // Message de confirmation temporaire
          const row = selectElement.closest('tr');
          const originalBg = row.className;
          row.className = 'border-t bg-green-100';
          setTimeout(() => {
            row.className = originalBg;
          }, 500);
        } else {
          selectElement.classList.remove('border-green-300', 'bg-green-50');
          selectElement.classList.add('border-red-300', 'bg-red-50');
        }
      }
      
      console.log(`‚úÖ Compte ligne ${index + 1} modifi√©: ${compte}`);
    }

    let comptesCharges = [
      { code: '601000', label: 'FR - MP & Serv. INDUCTEURS' },
      { code: '601001', label: 'FR - MP PDR' },
      { code: '601002', label: 'FR - SERVICE TSE' },
      { code: '601003', label: 'FR - MP GHFR STOCK' },
      { code: '601004', label: 'FR - MP RETROFIT' },
      { code: '601005', label: 'FR - GENERATEURS ET EQUIPEMENTS' },
      { code: '601100', label: 'UE - MP INDUCTEURS' },
      { code: '601101', label: 'UE - MP INDUCTEURS GHE' },
      { code: '601102', label: 'UE - GENERATEURS ET EQUIPEMENTS GHE' },
      { code: '601103', label: 'UE - SERVICES' },
      { code: '601104', label: 'UE - SERVICES GHE' },
      { code: '601105', label: 'UE - PIECES DE RECHANGE' },
      { code: '601106', label: 'UE - PIECES DE RECHANGE GHE' },
      { code: '601107', label: 'UE - RETROFIT' },
      { code: '601108', label: 'UE - RETROFIT GHE' },
      { code: '601109', label: 'UE - MP GHFR STOCK' },
      { code: '601200', label: 'HORS UE - PDR' },
      { code: '601210', label: 'HORS UE - SERVICE' },
      { code: '604000', label: 'ACHATS ETUDES & PS - AUTOLI' },
      { code: '604100', label: 'ACHATS ETUDES & PS 20%' },
      { code: '604200', label: 'ACHATS ETUDES & PS TTC' },
      { code: '606110', label: 'Electricit√© 20%' },
      { code: '606115', label: 'Electricit√© 5.5%' },
      { code: '606130', label: 'Eau' },
      { code: '606150', label: 'CARBURANT TTC' },
      { code: '606160', label: 'CARBURANTS - GAS-OIL DED 80%' },
      { code: '606161', label: 'CARBURANT GO INTRACOM' },
      { code: '606162', label: 'AMS - CARBURANT - GAS-OIL DED 80%' },
      { code: '606170', label: 'ATM - CARBURANTS - GAS-OIL TTC' },
      { code: '606171', label: 'ATM - CARBURANTS GAS-OIL DED 80%' },
      { code: '606172', label: 'ATM - CARBURANTS GO INTRACOM' },
      { code: '606300', label: 'Fournit. entretien & petit √©quip.' },
      { code: '606310', label: 'Four, entret. pt. mat. ttc' },
      { code: '606320', label: 'FOURN. ENTRET ET EQUIP INTRACO' },
      { code: '606330', label: 'Fourni. entretien & petit √©quip 10%' },
      { code: '606340', label: 'Fournit, entretien & petit √©qui 5,5%' },
      { code: '606420', label: 'FOURNITURE ADMINISTRATIVE INTR' },
      { code: '612201', label: 'APOLLO - CB LAND ROVER' },
      { code: '613200', label: 'Locations immobili√®res' },
      { code: '613507', label: 'SAET - location HD-918-BW' },
      { code: '613508', label: 'LOCATION SKODA GT-440-FT' },
      { code: '613509', label: 'LOCATION BMW GM-510-XM GHFR' },
      { code: '613510', label: 'LOCATION HD-005-BX GHFR' },
      { code: '613511', label: 'LOCAT PEUGEOT 308 GK-537-LR GHFR' },
      { code: '613512', label: 'ATM - LOCATION HYUNDAI GK-194-QL' },
      { code: '613513', label: 'LOCATION VOITURE TTC' },
      { code: '613520', label: 'Location bouteilles - GAZ' },
      { code: '613530', label: 'Location Logiciel SAGE' },
      { code: '613540', label: 'Location solution N2F' },
      { code: '613800', label: 'LOCATIONS DIVERSES' },
      { code: '615200', label: 'Sur biens immobiliers' },
      { code: '615529', label: 'APOLLO - ENTRETIEN FD-711-RW' },
      { code: '615530', label: 'ENTRETIEN HD-005-BX' },
      { code: '615531', label: 'ENTRETIEN DN-880-RY' },
      { code: '615532', label: 'ENTRETIEN GM-510-XM' },
      { code: '615533', label: 'ENTRETIEN GT-440-FT' },
      { code: '615540', label: 'ATM - ENTRETIEN GK-194-QL' },
      { code: '615550', label: 'AMS - ENTRETIEN GK-537-LR' },
      { code: '615600', label: 'Maintenance' },
      { code: '622600', label: 'Honoraires' },
      { code: '622601', label: 'Honoraires juridiques' },
      { code: '622700', label: 'Frais d\'actes et de contentieux' },
      { code: '624100', label: 'TRANSPORT SUR ACHAT INTRACOM' },
      { code: '624110', label: 'Transport sur achat 20%' },
      { code: '624130', label: 'TRANSPORT DE MARCHANDISE 20%' },
      { code: '624140', label: 'TRANSPORT DE MARCHANDISE HORS CEE' },
      { code: '624200', label: 'TRANSPORT SUR ACHAT 20%' },
      { code: '625100', label: 'Voyages et d√©placements' },
      { code: '625105', label: 'AMS - VOYAGE ET DEPLACEMENT TTC' },
      { code: '625106', label: 'AMS - VOYAGE ET DEPLACEMENT 20%' },
      { code: '625107', label: 'AMS - VOYAGE ET DEPLACEMENT 10%' },
      { code: '625109', label: 'AMS - VOYAGE ET DEPLACEMENT INTRACOM' },
      { code: '625110', label: 'GHFR - VOYAGES ET DEPLACEMENTS 10%' },
      { code: '625111', label: 'GHFR - VOYAGES ET DEPLACEMENTS TTC' },
      { code: '625112', label: 'GHFR - VOYAGE ET DEPLACEMENT INTRACOM' },
      { code: '625114', label: 'GHFR - VOYAGE ET DEPLCAEMENT 20%' },
      { code: '625115', label: 'ATM - VOYAGE ET DEPLACEMENT TTC' },
      { code: '625116', label: 'ATM - VOYAGE ET DEPLACEMENT 20%' },
      { code: '625117', label: 'ATM - VOYAGE ET DEPLACEMENT 10%' },
      { code: '625119', label: 'ATM - VOYAGE ET DEPLACEMENT INTRACOM' },
      { code: '625120', label: 'GHFR - PEAGES 20%' },
      { code: '625121', label: 'ATM - PEAGE 20%' },
      { code: '625123', label: 'ATM - PEAGE TTC' },
      { code: '625125', label: 'SAET - VOYAGE ET DEPLACEMENT TTC' },
      { code: '625700', label: 'RESTAURANT 20%' },
      { code: '625710', label: 'RESTAURANT 10%' },
      { code: '625711', label: 'RESTAURANT 5,5%' },
      { code: '626000', label: 'Frais postaux' },
      { code: '626001', label: 'Frais postaux TTC' },
    ];

    let comptesFournisseurs = [
      { code: '4010AA', label: 'AALBERTS' },
      { code: '4010AC', label: 'ACM COTISATION ASSURANCE' },
      { code: '4010AE', label: 'AREAS ASSURANCES' },
      { code: '4010AI', label: 'AIR TECHNIQUES' },
      { code: '4010AK', label: 'AJAX TOCCO Magnethermic UK' },
      { code: '4010AM', label: 'AMAZON' },
      { code: '4010AR', label: 'AIR PRODUCTS' },
      { code: '4010AS', label: 'ASTE' },
      { code: '4010AT', label: 'ATM WARREN' },
      { code: '4010AV', label: 'ARVAL' },
      { code: '4010AY', label: 'AYVENS' },
      { code: '4010BA', label: 'BAUMANN' },
      { code: '4010BC', label: 'BECHTLE' },
      { code: '4010BD', label: 'BRICO DEPOT' },
      { code: '4010BN', label: 'BINOMI' },
      { code: '4010BO', label: 'BOUYGUES' },
      { code: '4010BV', label: 'BUREAU VERITAS' },
      { code: '4010BX', label: 'BENE INOX' },
      { code: '4010CA', label: 'CAEN ESPACE AFFAIRE' },
      { code: '4010CB', label: 'CB' },
      { code: '4010CC', label: 'CCI CAMPUS' },
      { code: '4010CD', label: 'Coeur de foyer' },
      { code: '4010CI', label: 'CIC LEASING' },
      { code: '4010CO', label: 'CO-PILOTES' },
      { code: '4010CP', label: 'CHRONOPOST' },
      { code: '4010CS', label: 'CARBOSYSTEM' },
      { code: '4010CT', label: 'CASTOLIN EUTECTIC' },
      { code: '4010CV', label: 'CEVA' },
      { code: '4010DH', label: 'DHL EXPRESS' },
      { code: '4010EC', label: 'ESTEVAN CALVO' },
      { code: '4010ED', label: 'EDF' },
      { code: '4010EF', label: 'EFRAPO' },
      { code: '4010EG', label: 'EGLINSDOERFER PFOHL' },
      { code: '4010EM', label: 'EMG PRESSE' },
      { code: '4010ET', label: 'ELECTRO-RHIN' },
      { code: '4010EV', label: 'ECOVIS' },
      { code: '4010EX', label: 'COLMARIENNE DES EAUX' },
      { code: '4010FD', label: 'FOURNISSEURS DIVERS' },
      { code: '4010FE', label: 'FRANCE EXPRESS' },
      { code: '4010FI', label: 'FIDUCIAL' },
      { code: '4010FN', label: 'FINAL AM' },
      { code: '4010FR', label: 'FREE' },
      { code: '4010GA', label: 'GH GERMANY' },
      { code: '4010GC', label: 'GROSCLAUDE ROBIN' },
      { code: '4010GH', label: 'GH ELECTROTHERMIA' },
      { code: '4010GI', label: 'GH INDUCTION ATMOSPHERES' },
      { code: '4010GL', label: 'GL EVENTS' },
      { code: '4010GM', label: 'G.MAIER' },
      { code: '4010GP', label: 'GROUPE ADF' },
      { code: '4010GR', label: 'GREFFE DU TRIBUNAL' },
      { code: '4010GU', label: 'GUS EI' },
      { code: '4010HA', label: 'Hanna Instrumments' },
      { code: '4010IC', label: 'ICM' },
      { code: '4010IG', label: 'INFOGREFFE' },
      { code: '4010IO', label: 'IONOS' },
      { code: '4010KL', label: 'KILOUTOU' },
      { code: '4010LD', label: 'LAUDA' },
      { code: '4010LE', label: 'LECLERC' },
      { code: '4010LS', label: 'LetMeShip' },
      { code: '4010ME', label: 'MEDIACO' },
      { code: '4010MG', label: 'MATRIGALSA' },
      { code: '4010ML', label: 'MOLDES 2010' },
      { code: '4010MT', label: 'M√©decine travail' },
      { code: '4010NC', label: 'NDF CONRAUD' },
      { code: '4010ND', label: 'NDF DIVERS' },
      { code: '4010NF', label: 'N2F' },
      { code: '4010NH', label: 'NHP' },
      { code: '4010NJ', label: 'NDF POURCHAUX' },
      { code: '4010NM', label: 'NDF MARQUIS' },
      { code: '4010NO', label: 'NOVAPLEST' },
      { code: '4010NP', label: 'NDF PATARD' },
      { code: '4010NS', label: 'NDF CARRIERE' },
      { code: '4010NT', label: 'NDF THOMAS' },
      { code: '4010NV', label: 'NDF BUFFENOIR' },
      { code: '4010OR', label: 'ORANGE' },
      { code: '4010PE', label: 'PEAGE' },
      { code: '4010PS', label: 'LA POSTE' },
      { code: '4010PT', label: 'PROTEVAL' },
      { code: '4010RS', label: 'RS' },
      { code: '4010SB', label: 'STAUBLI' },
      { code: '4010SC', label: 'SCI DIKATES' },
      { code: '4010SG', label: 'SAGE' },
      { code: '4010ST', label: 'SEIT ELETTRONICA' },
      { code: '4010SU', label: 'SUEZ' },
      { code: '4010TL', label: 'TALLERES IRANZO' },
      { code: '4010TM', label: 'TM INDUSTRY' },
      { code: '4010TN', label: 'TNT FEDEX' },
      { code: '4010TS', label: 'TRANSPORT' },
      { code: '4010UL', label: 'ULYS' },
      { code: '4010VC', label: 'VOCA CONSEIL' },
      { code: '4010ZG', label: 'ZIEGLER' },
    ];

    let comptesTVA = [
      { code: '445662', label: 'Taux r√©duit' },
      { code: '445666', label: 'Taux interm√©diaire' },
      { code: '445667', label: 'TVA d√©ductible 20%' },
      { code: '445668', label: 'TVA d√©ductible Intracomm' },
      { code: '445200', label: 'TVA collect√©e Intracomm' },
    ];

    function saveApiKey() {
      const key = document.getElementById('apiKey').value.trim();
      if (!key) {
        alert('‚ö†Ô∏è Veuillez entrer une cl√© API');
        return;
      }
      if (!key.startsWith('AIza')) {
        alert('‚ö†Ô∏è Format de cl√© invalide. Une cl√© Gemini commence par "AIza"');
        return;
      }
      localStorage.setItem('gemini_api_key', key);
      alert('‚úÖ Cl√© API sauvegard√©e avec succ√®s !');
    }

    function loadApiKey() {
      const key = localStorage.getItem('gemini_api_key');
      if (key) {
        document.getElementById('apiKey').value = key;
      }
    }

    window.addEventListener('DOMContentLoaded', loadApiKey);

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

// üÜï Permettre le clic sur la zone
dropZone.addEventListener('click', () => {
  fileInput.click();
});

// üÜï Feedback visuel au survol
dropZone.ondragover = (e) => {
  e.preventDefault();
  e.stopPropagation();
  dropZone.classList.add('border-blue-500', 'bg-blue-100');
};

// üÜï Retirer le feedback quand on sort
dropZone.ondragleave = (e) => {
  e.preventDefault();
  e.stopPropagation();
  dropZone.classList.remove('border-blue-500', 'bg-blue-100');
};

dropZone.ondrop = (e) => {
  e.preventDefault();
  e.stopPropagation();
  dropZone.classList.remove('border-blue-500', 'bg-blue-100'); // üÜï Retirer feedback
  
  console.log('[DROP ZONE] Fichiers d√©pos√©s');
  const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
  console.log('[DROP ZONE] Fichiers PDF trouv√©s:', files.length);
  
  if (files.length > 0) {
    selectedFiles = files;
    console.log('[DROP ZONE] selectedFiles mis √† jour:', selectedFiles);
    displayFilesList();
  } else {
    alert('‚ö†Ô∏è Veuillez s√©lectionner uniquement des fichiers PDF'); // üÜï Alerte utilisateur
  }
};

fileInput.onchange = (e) => {
  console.log('[FILE INPUT] Changement d√©tect√©');
  const files = Array.from(e.target.files).filter(f => f.type === 'application/pdf');
  console.log('[FILE INPUT] Fichiers PDF trouv√©s:', files.length);
  
  if (files.length > 0) {
    selectedFiles = files;
    console.log('[FILE INPUT] selectedFiles mis √† jour:', selectedFiles);
    displayFilesList();
  } else {
    alert('‚ö†Ô∏è Veuillez s√©lectionner uniquement des fichiers PDF'); // üÜï Alerte utilisateur
  }
};
    function displayFilesList() {
  const listDiv = document.getElementById('filesListContent');
  listDiv.innerHTML = selectedFiles.map((file, index) => `
    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
      <div class="flex items-center gap-3">
        <span class="text-2xl">üìÑ</span>
        <div>
          <p class="font-medium text-gray-800">${file.name}</p>
          <p class="text-xs text-gray-500">${(file.size / 1024).toFixed(0)} KB</p>
        </div>
      </div>
      <button onclick="removeFile(${index})" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm">
        Retirer
      </button>
    </div>
  `).join('');
  
  document.getElementById('filesList').classList.remove('hidden');
  document.getElementById('results').classList.add('hidden');
}

function removeFile(index) {
  selectedFiles.splice(index, 1);
  if (selectedFiles.length === 0) {
    document.getElementById('filesList').classList.add('hidden');
    document.getElementById('fileName').textContent = '';
  } else {
    displayFilesList();
  }
}

// üÜï Variable globale pour annulation
let isProcessingCancelled = false;

async function processAllFiles() {
  console.log('[PROCESS] üöÄ D√©but du traitement batch');
  
  if (selectedFiles.length === 0) {
    console.error('[PROCESS] ‚ùå selectedFiles est vide');
    alert('‚ö†Ô∏è Aucun fichier s√©lectionn√©');
    return;
  }

  const apiKey = localStorage.getItem('gemini_api_key');
  console.log('[PROCESS] üîë Cl√© API:', apiKey ? apiKey.substring(0, 15) + '...' : 'MANQUANTE');
  
  if (!apiKey) {
    alert('‚ö†Ô∏è Veuillez configurer votre cl√© API Gemini');
    return;
  }

  // üÜï R√©initialiser le flag d'annulation
  isProcessingCancelled = false;
  
  const loadingDiv = document.getElementById('loading');
  loadingDiv.classList.remove('hidden');
  document.getElementById('filesList').classList.add('hidden');
  
  // üÜï Ajouter bouton annuler
  const progressDiv = document.getElementById('progressText');
  progressDiv.innerHTML = `
    Traitement de 0/${selectedFiles.length}: D√©marrage...
    <br>
    <button onclick="cancelProcessing()" class="mt-3 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">
      ‚ùå Annuler le traitement
    </button>
  `;
  
  let allInvoicesData = [];
  let successCount = 0;
  let errorCount = 0;
  let errorDetails = []; // üÜï Stocker les d√©tails des erreurs

  console.log(`[PROCESS] üìä ${selectedFiles.length} fichier(s) √† traiter`);

  for (let i = 0; i < selectedFiles.length; i++) {
    // üÜï V√©rifier si annulation demand√©e
    if (isProcessingCancelled) {
      console.log('[PROCESS] üõë Traitement annul√© par l\'utilisateur');
      alert(`‚ö†Ô∏è Traitement annul√© !\n${successCount} factures trait√©es avant annulation`);
      break;
    }
    
    const file = selectedFiles[i];
    
    // üÜï Calcul du pourcentage
    const percentage = Math.round(((i + 1) / selectedFiles.length) * 100);
    
    progressDiv.innerHTML = `
      <div class="mb-2">
        <div class="flex justify-between text-sm mb-1">
          <span>Traitement de ${i + 1}/${selectedFiles.length}: ${file.name}</span>
          <span>${percentage}%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
          <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
        </div>
      </div>
      <button onclick="cancelProcessing()" class="mt-3 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">
        ‚ùå Annuler le traitement
      </button>
    `;

    console.log(`[PROCESS] üìÑ [${i + 1}/${selectedFiles.length}] Traitement: ${file.name}`);

    try {
      const invoiceData = await analyzeInvoiceForBatch(file, apiKey);
      
      if (invoiceData) {
        allInvoicesData.push(invoiceData);
        successCount++;
        console.log(`[PROCESS] ‚úÖ [${i + 1}/${selectedFiles.length}] Succ√®s: ${file.name}`);
      } else {
        errorCount++;
        errorDetails.push({ file: file.name, error: 'Aucune donn√©e retourn√©e' }); // üÜï
        console.warn(`[PROCESS] ‚ö†Ô∏è [${i + 1}/${selectedFiles.length}] Aucune donn√©e: ${file.name}`);
      }
      
      // üÜï Pause adaptative selon le nombre de fichiers
      if (i < selectedFiles.length - 1) {
        const pauseDuration = selectedFiles.length > 10 ? 1000 : 2000;
        console.log(`[PROCESS] ‚è≥ Pause ${pauseDuration}ms...`);
        await new Promise(resolve => setTimeout(resolve, pauseDuration));
      }
    } catch (error) {
      console.error(`[PROCESS] ‚ùå [${i + 1}/${selectedFiles.length}] Erreur:`, error);
      errorCount++;
      errorDetails.push({ file: file.name, error: error.message }); // üÜï
    }
  }

  loadingDiv.classList.add('hidden');
  console.log(`[PROCESS] üèÅ Termin√©: ${successCount} succ√®s, ${errorCount} erreurs`);
  
  if (allInvoicesData.length > 0) {
    console.log('[PROCESS] üìä Affichage des r√©sultats...');
    displayBatchResults(allInvoicesData);
    
    // üÜï Message d√©taill√© avec les erreurs
    let message = `‚úÖ Traitement termin√© !\n\n${successCount} factures trait√©es avec succ√®s`;
    if (errorCount > 0) {
      message += `\n${errorCount} erreurs:\n`;
      errorDetails.forEach(err => {
        message += `\n‚Ä¢ ${err.file}: ${err.error}`;
      });
    }
    message += `\n\nV√©rifiez les r√©sultats ci-dessous avant d'exporter.`;
    alert(message);
  } else {
    console.error('[PROCESS] ‚ùå Aucune facture trait√©e avec succ√®s');
    
    // üÜï Afficher les erreurs d√©taill√©es
    let errorMsg = '‚ùå Aucune facture n\'a pu √™tre trait√©e\n\nErreurs d√©tect√©es:\n';
    errorDetails.forEach(err => {
      errorMsg += `\n‚Ä¢ ${err.file}: ${err.error}`;
    });
    alert(errorMsg);
  }
  
  selectedFiles = [];
  console.log('[PROCESS] üßπ selectedFiles r√©initialis√©');
}

// üÜï Fonction d'annulation
function cancelProcessing() {
  if (confirm('‚ö†Ô∏è Voulez-vous vraiment annuler le traitement en cours ?')) {
    isProcessingCancelled = true;
  }
}
    function generateEntriesForInvoice(inv) {
  const entries = [];
  const isAvoir = inv.est_avoir || inv.montant_ht < 0;
  const isIntracomm = inv.est_intracomm === true;
  
  // Extraction PDR
  let referencePDR = null;
  if (inv.description) {
    const match = inv.description.match(/PDR-\d{2}-\d{4}/i);
    if (match) referencePDR = match[0].toUpperCase();
  }
  if (!referencePDR && inv.reference_interne) {
    const match = inv.reference_interne.match(/PDR-\d{2}-\d{4}/i);
    if (match) referencePDR = match[0].toUpperCase();
  }
  
  const libelle = referencePDR || inv.reference_interne || inv.fournisseur;
  
  if (isAvoir) {
    const montantHTAvoir = Math.abs(inv.montant_ht);
    const montantTVAAvoir = Math.abs(inv.montant_tva);
    const montantTTCAvoir = Math.abs(inv.montant_ttc);
    
    entries.push(
      { accountType: 'fournisseur', compte: '4010FD', montant: montantTTCAvoir.toFixed(2), sens: 'D', libelle },
      { accountType: 'charge', compte: '601000', montant: montantHTAvoir.toFixed(2), sens: 'C', libelle },
      { accountType: 'tva', compte: '445667', montant: montantTVAAvoir.toFixed(2), sens: 'C', libelle }
    );
  } else if (isIntracomm) {
    const tvaIntra = (inv.montant_ht * 0.20).toFixed(2);
    entries.push(
      { accountType: 'charge', compte: '601100', montant: inv.montant_ht.toFixed(2), sens: 'D', libelle },
      { accountType: 'tva', compte: '445668', montant: tvaIntra, sens: 'D', libelle },
      { accountType: 'tva', compte: '445200', montant: tvaIntra, sens: 'C', libelle },
      { accountType: 'fournisseur', compte: '4010FD', montant: inv.montant_ht.toFixed(2), sens: 'C', libelle }
    );
  } else {
    entries.push(
      { accountType: 'charge', compte: '606110', montant: inv.montant_ht.toFixed(2), sens: 'D', libelle },
      { accountType: 'tva', compte: '445667', montant: inv.montant_tva.toFixed(2), sens: 'D', libelle },
      { accountType: 'fournisseur', compte: '4010FD', montant: inv.montant_ttc.toFixed(2), sens: 'C', libelle }
    );
  }
  
  return entries;
}

function updateLibelle(numFacture, entryIndex, newLibelle) {
  const inv = window.batchInvoicesData.find(i => i.numero_facture === numFacture);
  if (!inv) return;
  
  if (!inv.customLibelles) inv.customLibelles = {};
  inv.customLibelles[entryIndex] = newLibelle;
  console.log(`Libell√© mis √† jour pour ${numFacture}:`, newLibelle);
}
function displayBatchResults(allInvoicesData) {
  document.getElementById('results').classList.remove('hidden');
  
  // Sauvegarder globalement
  window.batchInvoicesData = allInvoicesData;
  
  // G√©n√©ration du tableau d'√©critures comptables
  const tbody = document.getElementById('batchBody');
  tbody.innerHTML = allInvoicesData.map((inv, idx) => {
    return `
      <tr class="hover:bg-gray-50">
        <td class="px-4 py-3 font-mono text-xs">${inv.numero_facture}</td>
        <td class="px-4 py-3 text-sm">${formatDate(inv.date)}</td>
        <td class="px-4 py-3 text-sm">${inv.fournisseur}</td>
        <td class="px-4 py-3">
          <input type="text" 
                 id="libelle-${idx}" 
                 value="${inv.reference_interne || inv.fournisseur}" 
                 onchange="updateInvoiceLibelle(${idx}, this.value)"
                 class="w-full px-2 py-1 border rounded text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                 placeholder="PDR-XX-XXXX ou r√©f√©rence">
        </td>
        <td class="px-4 py-3 text-right font-semibold text-sm">${inv.montant_ht.toFixed(2)} ‚Ç¨</td>
        <td class="px-4 py-3 text-right font-semibold text-sm">${inv.montant_tva.toFixed(2)} ‚Ç¨</td>
        <td class="px-4 py-3 text-right font-bold text-sm">${inv.montant_ttc.toFixed(2)} ‚Ç¨</td>
        <td class="px-4 py-3 text-center">
          ${inv.est_intracomm ? '<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-semibold">üá™üá∫ UE</span>' : ''}
          ${inv.est_avoir ? '<span class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs font-semibold">üìÑ AVOIR</span>' : ''}
          ${!inv.est_intracomm && !inv.est_avoir ? '<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs">FR</span>' : ''}
        </td>
<td class="px-4 py-3 text-center">
  <button onclick="openAccountSelectorModal(${idx})" 
          class="text-blue-500 hover:text-blue-700 hover:bg-blue-50 rounded px-2 py-1 text-xs font-semibold mr-2">
    ‚öôÔ∏è Comptes
  </button>
  <button onclick="removeInvoiceFromBatch(${idx})" 
          class="text-red-500 hover:text-red-700 hover:bg-red-50 rounded px-2 py-1 text-xs font-semibold">
    üóëÔ∏è Suppr.
  </button>
</td>
      </tr>
    `;
  }).join('');
}

function openAccountSelectorModal(invoiceIndex) {
  const inv = window.batchInvoicesData[invoiceIndex];
  
  // G√©n√©rer les √©critures pour cette facture
  const entries = generateEntriesForInvoice(inv);
  
  // Stocker temporairement les comptes personnalis√©s s'ils existent
  if (!inv.customAccounts) inv.customAccounts = {};
  if (!inv.deletedEntries) inv.deletedEntries = [];
  
  const modalHtml = `
    <div id="accountSelectorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
        <h3 class="text-xl font-bold mb-4">‚öôÔ∏è Configuration des comptes - ${inv.fournisseur}</h3>
        <p class="text-sm text-gray-600 mb-4">Facture ${inv.numero_facture} - ${formatDate(inv.date)}</p>
        
        <table class="w-full border">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-3 py-2 text-left">Type</th>
              <th class="px-3 py-2 text-left">Compte</th>
              <th class="px-3 py-2 text-right">Montant</th>
              <th class="px-3 py-2 text-center">D/C</th>
              <th class="px-3 py-2 text-center">Action</th>
            </tr>
          </thead>
          <tbody id="entriesTableBody">
            ${entries.map((e, i) => {
              const isDeleted = inv.deletedEntries.includes(i);
              return `
              <tr id="entry-row-${i}" class="border-t ${isDeleted ? 'opacity-30 bg-red-50' : ''}">
                <td class="px-3 py-2 text-sm">
                  <span class="px-2 py-1 rounded text-xs font-medium ${
                    e.accountType === 'charge' ? 'bg-blue-100 text-blue-700' :
                    e.accountType === 'fournisseur' ? 'bg-purple-100 text-purple-700' :
                    'bg-amber-100 text-amber-700'
                  }">${e.accountType}</span>
                </td>
                <td class="px-3 py-2">
                  <select id="modal-account-${i}" class="border rounded px-2 py-1 w-full text-sm" 
                          data-entry-index="${i}" data-account-type="${e.accountType}" ${isDeleted ? 'disabled' : ''}>
                    <option value="">-- S√©lectionner --</option>
                    ${getAccountsByType(e.accountType).map(a => 
                      `<option value="${a.code}" ${(inv.customAccounts[i] || e.compte) === a.code ? 'selected' : ''}>${a.code} - ${a.label}</option>`
                    ).join('')}
                  </select>
                </td>
                <td class="px-3 py-2 text-right font-semibold">${e.montant} ‚Ç¨</td>
                <td class="px-3 py-2 text-center">
                  <span class="px-2 py-1 rounded text-xs font-semibold ${e.sens === 'D' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                    ${e.sens}
                  </span>
                </td>
                <td class="px-3 py-2 text-center">
                  ${isDeleted ? 
                    `<button onclick="restoreEntry(${invoiceIndex}, ${i})" class="text-green-500 hover:text-green-700 text-xs font-semibold">‚Ü©Ô∏è Restaurer</button>` :
                    `<button onclick="deleteEntry(${invoiceIndex}, ${i})" class="text-red-500 hover:text-red-700 text-xs font-semibold">üóëÔ∏è Supprimer</button>`
                  }
                </td>
              </tr>
            `}).join('')}
          </tbody>
        </table>
        
        <div class="flex gap-2 mt-6">
          <button onclick="saveAccountsForInvoice(${invoiceIndex})" 
                  class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
            ‚úÖ Enregistrer
          </button>
          <button onclick="closeAccountSelectorModal()" 
                  class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
            ‚ùå Annuler
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function saveAccountsForInvoice(invoiceIndex) {
  const inv = window.batchInvoicesData[invoiceIndex];
  const entries = generateEntriesForInvoice(inv);
  
  if (!inv.customAccounts) inv.customAccounts = {};
  
  // Sauvegarder les comptes s√©lectionn√©s
  entries.forEach((e, i) => {
    const select = document.getElementById(`modal-account-${i}`);
    if (select && select.value) {
      inv.customAccounts[i] = select.value;
    }
  });
  
  closeAccountSelectorModal();
  alert('‚úÖ Comptes sauvegard√©s pour cette facture');
}

function closeAccountSelectorModal() {
  const modal = document.getElementById('accountSelectorModal');
  if (modal) modal.remove();
}

function deleteEntry(invoiceIndex, entryIndex) {
  const inv = window.batchInvoicesData[invoiceIndex];
  if (!inv.deletedEntries) inv.deletedEntries = [];
  
  if (!inv.deletedEntries.includes(entryIndex)) {
    inv.deletedEntries.push(entryIndex);
  }
  
  // Rafra√Æchir le modal
  closeAccountSelectorModal();
  openAccountSelectorModal(invoiceIndex);
}

function restoreEntry(invoiceIndex, entryIndex) {
  const inv = window.batchInvoicesData[invoiceIndex];
  if (!inv.deletedEntries) inv.deletedEntries = [];
  
  const idx = inv.deletedEntries.indexOf(entryIndex);
  if (idx > -1) {
    inv.deletedEntries.splice(idx, 1);
  }
  
  // Rafra√Æchir le modal
  closeAccountSelectorModal();
  openAccountSelectorModal(invoiceIndex);
}    
    
// üÜï Fonction pour formater la date
function formatDate(dateStr) {
  if (dateStr && dateStr.length === 8) {
    const year = dateStr.substring(0, 4);
    const month = dateStr.substring(4, 6);
    const day = dateStr.substring(6, 8);
    return `${day}/${month}/${year}`;
  }
  return dateStr;
}

// üÜï Fonction pour supprimer une facture
function removeInvoiceFromBatch(index) {
  if (!confirm('‚ö†Ô∏è Supprimer cette facture du lot ?')) return;
  
  window.batchInvoicesData.splice(index, 1);
  
  if (window.batchInvoicesData.length === 0) {
    document.getElementById('results').classList.add('hidden');
    alert('‚úÖ Toutes les factures ont √©t√© retir√©es');
  } else {
    displayBatchResults(window.batchInvoicesData);
    alert('‚úÖ Facture supprim√©e');
  }
}

    function updateInvoiceLibelle(index, newLibelle) {
  if (window.batchInvoicesData && window.batchInvoicesData[index]) {
    window.batchInvoicesData[index].reference_interne = newLibelle;
    console.log(`‚úÖ Libell√© mis √† jour pour facture ${index}:`, newLibelle);
  }
}

function previewInvoiceEntries(index) {
  const inv = window.batchInvoicesData[index];
  
  // üîß CORRECTION 1: G√©n√©rer les vraies √©critures
  const previousData = extractedData;
  extractedData = inv;
  generateEntries();
  
  const entries = accountEntries.map(e => ({
    type: e.accountType === 'charge' ? 'Charge' : 
          e.accountType === 'fournisseur' ? 'Fournisseur' : 'TVA',
    compte: e.compte || '‚ö†Ô∏è NON D√âFINI',
    montant: e.montant,
    sens: e.sens
  }));
  
  extractedData = previousData;
  if (extractedData) generateEntries();
  
  const entriesHtml = entries.map(e => 
    `<tr class="border-t">
      <td class="px-3 py-2 text-sm">${e.type}</td>
      <td class="px-3 py-2 font-mono text-sm">${e.compte}</td>
      <td class="px-3 py-2 text-right font-semibold">${e.montant} ‚Ç¨</td>
      <td class="px-3 py-2 text-center">
        <span class="px-2 py-1 rounded text-xs ${e.sens === 'D' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
          ${e.sens}
        </span>
      </td>
    </tr>`
  ).join('');
  
  const modalHtml = `
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="this.remove()">
      <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">üìã √âcritures pour ${inv.fournisseur}</h3>
        <p class="text-sm text-gray-600 mb-4">Facture ${inv.numero_facture} - ${formatDate(inv.date)}</p>
        
        <table class="w-full border">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-3 py-2 text-left">Type</th>
              <th class="px-3 py-2 text-left">Compte</th>
              <th class="px-3 py-2 text-right">Montant</th>
              <th class="px-3 py-2 text-center">D/C</th>
            </tr>
          </thead>
          <tbody>
            ${entriesHtml}
          </tbody>
        </table>
        
        <button onclick="this.closest('.fixed').remove()" 
                class="mt-6 w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
          Fermer
        </button>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// üÜï Fonction pour recommencer
function resetBatch() {
  if (!confirm('‚ö†Ô∏è Effacer tous les r√©sultats et recommencer ?')) return;
  
  window.batchInvoicesData = [];
  document.getElementById('results').classList.add('hidden');
  document.getElementById('filesList').classList.add('hidden');
  selectedFiles = [];
  fileInput.value = '';
}

function confirmAndExportBatch() {
  if (!window.batchInvoicesData || window.batchInvoicesData.length === 0) {
    alert('‚ùå Aucune donn√©e √† exporter');
    return;
  }
  
  const count = window.batchInvoicesData.length;
  
  // V√©rification des dates
  const invalidDates = window.batchInvoicesData.filter(inv => 
    !inv.date || inv.date.length !== 8 || isNaN(inv.date)
  );
  
  if (invalidDates.length > 0) {
    alert(`‚ö†Ô∏è ${invalidDates.length} facture(s) ont des dates invalides.\nV√©rifiez les donn√©es avant export.`);
    return;
  }
  
  if (confirm(`üì§ Exporter ${count} facture(s) vers N2F/Sage ?\n\nV√©rifiez bien vos donn√©es avant de confirmer.`)) {
    exportMultipleInvoices(window.batchInvoicesData);
  }
}
function exportMultipleInvoices(allInvoicesData) {
  const code = document.getElementById('codeJournal').value;
  
  if (!code || code.length !== 2) {
    alert('‚ö†Ô∏è Le code journal doit contenir exactement 2 caract√®res');
    return;
  }
  
  const removeAccents = (str) => str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  
  let output = '';
  let totalLines = 0;
  
  allInvoicesData.forEach(invoiceData => {
    const numFacture = invoiceData.numero_facture;
    const date = invoiceData.date;
    const isAvoir = invoiceData.est_avoir || invoiceData.montant_ht < 0;
    const isIntracomm = invoiceData.est_intracomm === true;
    
    // G√©n√©rer les √©critures de base avec comptes personnalis√©s
    let entries = [];
    
    if (isAvoir) {
      const montantHTAvoir = Math.abs(invoiceData.montant_ht);
      const montantTVAAvoir = Math.abs(invoiceData.montant_tva);
      const montantTTCAvoir = Math.abs(invoiceData.montant_ttc);
      
      entries.push(
        { accountType: 'fournisseur', compte: invoiceData.customAccounts?.[0] || '4010FD', montant: montantTTCAvoir.toFixed(2), sens: 'D' },
        { accountType: 'charge', compte: invoiceData.customAccounts?.[1] || '601000', montant: montantHTAvoir.toFixed(2), sens: 'C' },
        { accountType: 'tva', compte: invoiceData.customAccounts?.[2] || '445667', montant: montantTVAAvoir.toFixed(2), sens: 'C' }
      );
    } else if (isIntracomm) {
      const tvaIntra = (invoiceData.montant_ht * 0.20).toFixed(2);
      entries.push(
        { accountType: 'charge', compte: invoiceData.customAccounts?.[0] || '601100', montant: invoiceData.montant_ht.toFixed(2), sens: 'D' },
        { accountType: 'tva', compte: invoiceData.customAccounts?.[1] || '445668', montant: tvaIntra, sens: 'D' },
        { accountType: 'tva', compte: invoiceData.customAccounts?.[2] || '445200', montant: tvaIntra, sens: 'C' },
        { accountType: 'fournisseur', compte: invoiceData.customAccounts?.[3] || '4010FD', montant: invoiceData.montant_ht.toFixed(2), sens: 'C' }
      );
    } else {
      entries.push(
        { accountType: 'charge', compte: invoiceData.customAccounts?.[0] || '606110', montant: invoiceData.montant_ht.toFixed(2), sens: 'D' },
        { accountType: 'tva', compte: invoiceData.customAccounts?.[1] || '445667', montant: invoiceData.montant_tva.toFixed(2), sens: 'D' },
        { accountType: 'fournisseur', compte: invoiceData.customAccounts?.[2] || '4010FD', montant: invoiceData.montant_ttc.toFixed(2), sens: 'C' }
      );
    }
    
// Extraction PDR et g√©n√©ration des lignes
entries.forEach((e, index) => {
  // üÜï Ignorer les lignes supprim√©es
  if (invoiceData.deletedEntries && invoiceData.deletedEntries.includes(index)) {
    return; // Skip cette ligne
  }
  
  let referencePDR = null;
  
  // Chercher PDR dans description
  if (invoiceData.description) {
    const match = invoiceData.description.match(/PDR-\d{2}-\d{4}/i);
    if (match) referencePDR = match[0].toUpperCase();
  }
  
  // Chercher dans reference_interne
  if (!referencePDR && invoiceData.reference_interne) {
    const match = invoiceData.reference_interne.match(/PDR-\d{2}-\d{4}/i);
    if (match) referencePDR = match[0].toUpperCase();
  }
  
  // Chercher dans numero_facture
  if (!referencePDR && invoiceData.numero_facture) {
    const match = invoiceData.numero_facture.match(/PDR-\d{2}-\d{4}/i);
    if (match) referencePDR = match[0].toUpperCase();
  }
  
  let libelle = '';
  if (referencePDR) {
    libelle = removeAccents(`${referencePDR} ${invoiceData.fournisseur}`);
  } else if (invoiceData.reference_interne) {
    libelle = removeAccents(`${invoiceData.reference_interne} ${invoiceData.fournisseur}`);
  } else {
    libelle = removeAccents(invoiceData.fournisseur);
  }
  libelle = libelle.substring(0, 25);
  
  let description = '';
  if (referencePDR) {
    description = removeAccents(`${referencePDR} ${invoiceData.fournisseur}`);
  } else if (invoiceData.reference_interne) {
    description = removeAccents(`${invoiceData.reference_interne} ${invoiceData.fournisseur}`);
  } else {
    description = removeAccents(
      e.accountType === 'charge' ? 
        (invoiceData.description || 'Achat') : 
        invoiceData.fournisseur
    );
  }
  description = description.substring(0, 34);
  
  const montantArrondi = Math.round(parseFloat(e.montant) * 100) / 100;
  const montantCentimes = Math.round(montantArrondi * 100);
  
  const line = 
    numFacture.toString().padStart(5, ' ') + ',' +
    code + ',' +
    date + ',' +
    ''.padEnd(20, ' ') + ',' +
    e.compte.padEnd(11, ' ') + ',' +
    libelle.padEnd(25, ' ') + ',' +
    montantCentimes.toString().padStart(13, ' ') + ',' +
    e.sens + ',' +
    ''.padEnd(12, ' ') + ',' +
    ''.padEnd(6, ' ') + ',' +
    description.padEnd(34, ' ') + ',' +
    '\r\n';
  
  output += line;
  totalLines++;
});

if (totalLines === 0) {
  alert('‚ùå Aucune √©criture g√©n√©r√©e');
  return;
}

const blob = new Blob([output], { type: 'text/plain;charset=utf-8' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;

const today = new Date();
const dateStr = today.getFullYear() + 
                String(today.getMonth() + 1).padStart(2, '0') + 
                String(today.getDate()).padStart(2, '0');

a.download = `ExportFile_Batch_${allInvoicesData.length}factures_${dateStr}.txt`;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);

alert(`‚úÖ Export r√©ussi !\n\n${allInvoicesData.length} factures export√©es\n${totalLines} √©critures comptables g√©n√©r√©es\n\nFichier: ExportFile_Batch_${allInvoicesData.length}factures_${dateStr}.txt`);
}
async function analyzeInvoiceForBatch(file, apiKey) {
  console.log(`[BATCH] üîÑ D√©but analyse: ${file.name}`);
  
  return new Promise((resolve) => {
    const reader = new FileReader();
    
    reader.onload = async () => {
      console.log(`[BATCH] üìÑ Fichier lu: ${file.name}`);
      
      try {
        const base64 = reader.result.split(',')[1];
        console.log(`[BATCH] üîê Base64 longueur: ${base64.length}`);
        
        // üÜï Timeout de 30 secondes
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          signal: controller.signal, // üÜï Ajout signal
          body: JSON.stringify({
            contents: [{
              parts: [
                {
                  text: `Tu es un expert-comptable fran√ßais. Analyse cette facture avec PR√âCISION MAXIMALE.

‚ö†Ô∏è R√àGLE ABSOLUE SUR LA TVA :
- Si tu vois un montant de TVA affich√© (ex: "TVA 20%: 45,60‚Ç¨" ou "TVA 10%", etc.) ‚Üí La facture EST fran√ßaise avec TVA
- Si tu vois "TVA non applicable", "Autoliquidation", "Reverse charge", ou mention pays UE ‚Üí ALORS c'est intracommunautaire
- JAMAIS les deux en m√™me temps !

R√àGLES D'EXTRACTION :
1. FOURNISSEUR = √©metteur de la facture (en-t√™te du document)
1bis. REFERENCE_INTERNE = Extraire imp√©rativement la r√©f√©rence de commande type PDR-XX-XXXXX (ex: PDR-24-00123)
2. Si TVA AFFICH√âE avec montant ‚Üí tva_taux = le taux indiqu√© ET est_intracomm = false
3. Si "TVA non applicable" OU fournisseur UE ‚Üí tva_taux = 0 ET est_intracomm = true
4. Si AVOIR ou montant n√©gatif ‚Üí est_avoir = true

R√©ponds UNIQUEMENT avec ce JSON (sans markdown, sans texte) :
{
  "fournisseur": "nom √©metteur",
  "numero_facture": "num√©ro",
  "date": "AAAAMMJJ",
  "montant_ht": nombre,
  "tva_taux": nombre,
  "montant_tva": nombre,
  "montant_ttc": nombre,
  "description": "description courte",
  "reference_interne": "ref client ou null",
  "categorie_suggeree": "cat√©gorie",
  "est_intracomm": false,
  "est_avoir": false
}`
                },
                {
                  inline_data: {
                    mime_type: 'application/pdf',
                    data: base64
                  }
                }
              ]
            }],
            generationConfig: {
              temperature: 0,
              maxOutputTokens: 2048
            }
          })
        });

        clearTimeout(timeoutId); // üÜï Nettoyer le timeout
        console.log(`[BATCH] üì° R√©ponse API status: ${response.status}`);

        if (!response.ok) {
          const errorText = await response.text();
          console.error(`[BATCH] ‚ùå Erreur API pour ${file.name}:`, errorText);
          
          // üÜï D√©tails d'erreur plus pr√©cis
          let errorMsg = `Erreur ${response.status}`;
          try {
            const errorJson = JSON.parse(errorText);
            errorMsg = errorJson.error?.message || errorMsg;
          } catch (e) {
            errorMsg = errorText.substring(0, 100);
          }
          
          alert(`‚ùå Erreur API pour ${file.name}:\n${errorMsg}`);
          resolve(null);
          return;
        }

        const data = await response.json();
        console.log(`[BATCH] üì• Donn√©es re√ßues pour ${file.name}`);
        
        // üÜï V√©rification de la structure de r√©ponse
        if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
          console.error(`[BATCH] ‚ùå Structure de r√©ponse invalide pour ${file.name}:`, data);
          alert(`‚ùå R√©ponse API invalide pour ${file.name}`);
          resolve(null);
          return;
        }
        
        const text = data.candidates[0].content.parts[0].text;
        const cleanText = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        const jsonMatch = cleanText.match(/\{[\s\S]*\}/);
        
        if (jsonMatch) {
          const invoiceData = JSON.parse(jsonMatch[0]);
          
          // üÜï Validation des champs obligatoires
          const requiredFields = ['fournisseur', 'numero_facture', 'date', 'montant_ht', 'montant_ttc'];
          const missingFields = requiredFields.filter(field => !invoiceData[field]);
          
          if (missingFields.length > 0) {
            console.error(`[BATCH] ‚ùå Champs manquants pour ${file.name}:`, missingFields);
            alert(`‚ö†Ô∏è Donn√©es incompl√®tes pour ${file.name}:\nChamps manquants: ${missingFields.join(', ')}`);
            resolve(null);
            return;
          }
          
          // üÜï Valeurs par d√©faut pour champs optionnels
          invoiceData.filename = file.name;
          invoiceData.est_intracomm = invoiceData.est_intracomm || false;
          invoiceData.est_avoir = invoiceData.est_avoir || false;
          invoiceData.tva_taux = invoiceData.tva_taux || 0;
          invoiceData.montant_tva = invoiceData.montant_tva || 0;
          
          console.log(`[BATCH] ‚úÖ Succ√®s: ${file.name} - ${invoiceData.fournisseur}`);
          resolve(invoiceData);
        } else {
          console.error(`[BATCH] ‚ùå Pas de JSON trouv√© pour ${file.name}`);
          console.error(`[BATCH] Texte re√ßu:`, cleanText);
          alert(`‚ùå Format de r√©ponse invalide pour ${file.name}`);
          resolve(null);
        }
        
      } catch (error) {
        console.error(`[BATCH] ‚ùå Erreur parsing ${file.name}:`, error);
        
        // üÜï Message d'erreur selon le type
        if (error.name === 'AbortError') {
          alert(`‚è±Ô∏è Timeout pour ${file.name} (>30s)`);
        } else {
          alert(`‚ùå Erreur technique pour ${file.name}:\n${error.message}`);
        }
        
        resolve(null);
      }
    };
    
    reader.onerror = (error) => {
      console.error(`[BATCH] ‚ùå Erreur lecture fichier ${file.name}:`, error);
      alert(`‚ùå Impossible de lire ${file.name}`);
      resolve(null);
    };
    
    reader.readAsDataURL(file);
  });
}

function displayResults() {
      // V√©rification de s√©curit√©
      if (!extractedData) {
        console.error('[displayResults] extractedData est null');
        return;
      }
      
      document.getElementById('results').classList.remove('hidden');
      
      const isAvoir = extractedData.est_avoir || extractedData.montant_ht < 0;
      const isIntracomm = extractedData.est_intracomm === true;
      
      document.getElementById('extractedData').innerHTML = `
        <div><p class="text-sm text-gray-500">Fournisseur</p><p class="font-semibold">${extractedData.fournisseur}</p></div>
        <div><p class="text-sm text-gray-500">N¬∞ Facture</p><p class="font-semibold">${extractedData.numero_facture}</p></div>
        <div><p class="text-sm text-gray-500">Date</p><p class="font-semibold">${formatDate(extractedData.date)}</p></div>
        ${extractedData.reference_interne ? `<div><p class="text-sm text-gray-500">R√©f√©rence</p><p class="font-semibold">${extractedData.reference_interne}</p></div>` : ''}
        <div><p class="text-sm text-gray-500">Montant HT</p><p class="font-semibold">${extractedData.montant_ht.toFixed(2)} ‚Ç¨</p></div>
        <div><p class="text-sm text-gray-500">TVA (${extractedData.tva_taux}%)</p><p class="font-semibold">${extractedData.montant_tva.toFixed(2)} ‚Ç¨</p></div>
        <div><p class="text-sm text-gray-500">Montant TTC</p><p class="font-semibold">${extractedData.montant_ttc.toFixed(2)} ‚Ç¨</p></div>
        ${isAvoir ? '<div class="col-span-3"><span class="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm font-semibold">üìÑ AVOIR</span></div>' : ''}
        ${isIntracomm ? '<div class="col-span-3"><span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">üá™üá∫ INTRACOMMUNAUTAIRE</span></div>' : ''}
      `;
      
      if (isIntracomm && !isAvoir) {
        document.getElementById('intracommButton').classList.remove('hidden');
      } else {
        document.getElementById('intracommButton').classList.add('hidden');
      }
      
      // üÜï Auto-g√©n√©rer les √©critures
      generateEntries();
    }

function generateEntries() {
      if (!extractedData) {
        console.error('[generateEntries] extractedData est null');
        return;
      }
      
      const numFacture = extractedData.numero_facture || 'ERROR';
      const code = document.getElementById('codeJournal').value;
      const piece = numFacture + code + extractedData.date;
      
      const isAvoir = extractedData.est_avoir || extractedData.montant_ht < 0;
      const isIntracomm = extractedData.est_intracomm === true;
      
      accountEntries = [];
      
      if (isAvoir) {
        const montantHTAvoir = Math.abs(extractedData.montant_ht);
        const montantTVAAvoir = Math.abs(extractedData.montant_tva);
        const montantTTCAvoir = Math.abs(extractedData.montant_ttc);
        
        accountEntries.push(
          { piece, accountType: 'fournisseur', compte: '4010FD', montant: montantTTCAvoir.toFixed(2), sens: 'D' },
          { piece, accountType: 'charge', compte: '601000', montant: montantHTAvoir.toFixed(2), sens: 'C' },
          { piece, accountType: 'tva', compte: '445667', montant: montantTVAAvoir.toFixed(2), sens: 'C' }
        );
      } else if (isIntracomm) {
        const tvaIntra = (extractedData.montant_ht * 0.20).toFixed(2);
        accountEntries.push(
          { piece, accountType: 'charge', compte: '601100', montant: extractedData.montant_ht.toFixed(2), sens: 'D' },
          { piece, accountType: 'tva', compte: '445668', montant: tvaIntra, sens: 'D' },
          { piece, accountType: 'tva', compte: '445200', montant: tvaIntra, sens: 'C' },
          { piece, accountType: 'fournisseur', compte: '4010FD', montant: extractedData.montant_ht.toFixed(2), sens: 'C' }
        );
      } else {
        accountEntries.push(
          { piece, accountType: 'charge', compte: '606110', montant: extractedData.montant_ht.toFixed(2), sens: 'D' },
          { piece, accountType: 'tva', compte: '445667', montant: extractedData.montant_tva.toFixed(2), sens: 'D' },
          { piece, accountType: 'fournisseur', compte: '4010FD', montant: extractedData.montant_ttc.toFixed(2), sens: 'C' }
        );
      }

      const tbody = document.getElementById('entriesTable');
      tbody.innerHTML = accountEntries.map((e, i) => `
        <tr class="border-t hover:bg-gray-50">
          <td class="px-4 py-2 font-mono text-sm">${e.piece}</td>
          <td class="px-4 py-2">
            <span class="px-2 py-1 rounded text-xs font-medium ${
              e.accountType === 'charge' ? 'bg-blue-100 text-blue-700' :
              e.accountType === 'fournisseur' ? 'bg-purple-100 text-purple-700' :
              'bg-amber-100 text-amber-700'
            }">${e.accountType}</span>
          </td>
          <td class="px-4 py-2">
            <select id="account-select-${i}" onchange="updateAccountAndRefresh(${i}, this.value)" class="border rounded px-2 py-1 w-full text-sm ${!e.compte ? 'border-red-300 bg-red-50' : 'border-gray-300'}">
              <option value="">-- S√©lectionner --</option>
              ${getAccountsByType(e.accountType).map(a => 
                `<option value="${a.code}" ${e.compte === a.code ? 'selected' : ''}>${a.code} - ${a.label}</option>`
              ).join('')}
            </select>
          </td>
          <td class="px-4 py-2 font-mono">${e.montant} ‚Ç¨</td>
          <td class="px-4 py-2">
            <span class="px-2 py-1 rounded text-xs font-semibold ${e.sens === 'D' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
              ${e.sens}
            </span>
          </td>
        </tr>
      `).join('');
    }

function exportToSage() {
      // üÜï V√©rifications compl√®tes
      if (!extractedData) {
        alert('‚ùå Aucune donn√©e √† exporter');
        return;
      }
      
      const hasEmpty = accountEntries.some(e => !e.compte);
      if (hasEmpty) {
        alert('‚ö†Ô∏è Tous les comptes doivent √™tre renseign√©s avant export');
        return;
      }
      
      const code = document.getElementById('codeJournal').value;
      if (!code || code.length !== 2) {
        alert('‚ö†Ô∏è Le code journal doit contenir exactement 2 caract√®res');
        return;
      }
      
      // üÜï V√©rification √©quilibre d√©bit/cr√©dit
      const totalDebit = accountEntries.filter(e => e.sens === 'D').reduce((sum, e) => sum + parseFloat(e.montant), 0);
      const totalCredit = accountEntries.filter(e => e.sens === 'C').reduce((sum, e) => sum + parseFloat(e.montant), 0);
      
      if (Math.abs(totalDebit - totalCredit) > 0.01) {
        alert(`‚ö†Ô∏è Les √©critures ne sont pas √©quilibr√©es !\n\nD√©bit: ${totalDebit.toFixed(2)} ‚Ç¨\nCr√©dit: ${totalCredit.toFixed(2)} ‚Ç¨\n\nDiff√©rence: ${Math.abs(totalDebit - totalCredit).toFixed(2)} ‚Ç¨`);
        return;
      }
      
      const numFacture = extractedData.numero_facture;
      const date = extractedData.date;
      
      const removeAccents = (str) => str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      
      let output = '';
       accountEntries.forEach(e => {
        // üÜï EXTRACTION REFERENCE PDR-XX-XXXX
        const pdrMatch = extractedData.description ? extractedData.description.match(/PDR-\d{2}-\d{4}/i) : null;
        const referencePDR = pdrMatch ? pdrMatch[0].toUpperCase() : null;
        
        let libelle = '';
        if (referencePDR) {
          libelle = removeAccents(referencePDR + ' ' + extractedData.fournisseur);
        } else if (extractedData.reference_interne) {
          libelle = removeAccents(extractedData.reference_interne + ' ' + extractedData.fournisseur);
        } else {
          libelle = removeAccents(extractedData.fournisseur);
        }
        libelle = libelle.substring(0, 25);
        
        let description = '';
        if (referencePDR) {
          description = removeAccents(referencePDR + ' ' + extractedData.fournisseur);
        } else if (extractedData.reference_interne) {
          description = removeAccents(extractedData.reference_interne + ' ' + extractedData.fournisseur);
        } else {
          description = removeAccents(
            e.accountType === 'charge' ? 
              (extractedData.description || 'Achat') : 
              extractedData.fournisseur
          );
        }
        description = description.substring(0, 34);
        
        const montantArrondi = Math.round(parseFloat(e.montant) * 100) / 100;
        const montantCentimes = Math.round(montantArrondi * 100);
        
        const line = 
          numFacture.toString().padStart(5, ' ') + ',' +
          code + ',' +
          date + ',' +
          ''.padEnd(20, ' ') + ',' +
          e.compte.padEnd(11, ' ') + ',' +
          libelle.padEnd(25, ' ') + ',' +
          montantCentimes.toString().padStart(13, ' ') + ',' +
          e.sens + ',' +
          ''.padEnd(12, ' ') + ',' +
          ''.padEnd(6, ' ') + ',' +
          description.padEnd(34, ' ') + ',' +
          '\r\n';
        
        output += line;
      });

      const blob = new Blob([output], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ExportFile_${removeAccents(extractedData.fournisseur).replace(/[^a-zA-Z0-9]/g, '_')}_${date}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      // üÜï Message d√©taill√©
      alert(`‚úÖ Export N2F r√©ussi !\n\nFournisseur: ${extractedData.fournisseur}\nFacture: ${numFacture}\nMontant: ${extractedData.montant_ttc.toFixed(2)} ‚Ç¨\n\n${accountEntries.length} √©critures g√©n√©r√©es`);
    }

  </script>
</body>
</html>
