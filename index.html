<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GÃ©nÃ©rateur Ã‰critures Comptables N2F/Sage</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-xl shadow-xl p-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">GÃ©nÃ©rateur d'Ã©critures comptables N2F / Sage</h1>
      <p class="text-gray-600 mb-8">Importez une facture PDF et gÃ©nÃ©rez automatiquement l'Ã©criture comptable</p>
      
      <!-- Configuration API Gemini -->
      <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div class="ml-3 flex-1">
            <p class="text-sm text-yellow-700 font-semibold mb-2">âš™ï¸ Configuration requise</p>
            <div class="flex gap-2">
              <input type="password" id="apiKey" placeholder="Votre API ici" class="flex-1 px-3 py-2 border rounded-lg text-sm">
              <button onclick="saveApiKey()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm whitespace-nowrap">
                ğŸ’¾ Sauvegarder
              </button>
              <a href="https://aistudio.google.com/app/apikey" target="_blank" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm whitespace-nowrap">
                ğŸ”‘ Obtenir clÃ©
              </a>
            </div>
            <p class="text-xs text-yellow-600 mt-2">ğŸ“Œ La clÃ© est stockÃ©e localement dans votre navigateur</p>
          </div>
        </div>
      </div>

      <div class="bg-blue-50 rounded-lg p-6 mb-6 border border-blue-200">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">ParamÃ¨tres</h2>
        <div class="mb-4">
  <label class="block text-sm font-medium text-gray-700 mb-2">Code journal</label>
  <input type="text" id="codeJournal" value="HA" maxlength="2" class="w-full px-3 py-2 border rounded-lg">
</div>
        
        <div class="flex gap-2">
          <button onclick="openAccountManager('charge')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm">
            GÃ©rer Comptes Charges
          </button>
          <button onclick="openAccountManager('fournisseur')" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm">
            GÃ©rer Comptes Fournisseurs
          </button>
          <button onclick="openAccountManager('tva')" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 text-sm">
            GÃ©rer Comptes TVA
          </button>
        </div>
      </div>

      <div class="mb-8">
        <label id="dropZone" class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-blue-300 rounded-lg cursor-pointer bg-blue-50 hover:bg-blue-100">
          <div class="text-center">
            <p class="mb-2 text-sm text-gray-700"><span class="font-semibold">Cliquez</span> ou glissez un PDF</p>
            <p id="fileName" class="text-xs text-gray-500"></p>
          </div>
          <input type="file" id="fileInput" accept="application/pdf" class="hidden" multiple>
        </label>
      </div>

      

     <div id="filesList" class="hidden mb-6">
  <h3 class="font-semibold text-gray-800 mb-2">Fichiers sÃ©lectionnÃ©s :</h3>
  <div id="filesListContent" class="space-y-2"></div>
  <button onclick="processAllFiles()" class="mt-4 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">
    ğŸ“Š Traiter toutes les factures
  </button>
</div>

<div id="loading" class="hidden text-center py-8">
  <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
  <p class="mt-4 text-gray-600">Analyse en cours...</p>
  <p id="progressText" class="text-sm text-gray-500 mt-2"></p>
</div>

      <div id="results" class="hidden">
        <div class="bg-gray-50 rounded-lg p-6 mb-6">
          <h2 class="text-xl font-semibold mb-4">DonnÃ©es extraites</h2>
          <div id="extractedData" class="grid grid-cols-3 gap-4"></div>
          <div id="intracommButton" class="hidden mt-4">
            <button onclick="applyAutoliquidation()" class="px-6 py-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">
              ğŸ‡ªğŸ‡º Appliquer Autoliquidation TVA Intracommunautaire
            </button>
          </div>
        </div>
<div id="batchContainer" class="mb-6">
  <h2 class="text-xl font-semibold mb-4 text-gray-800">ğŸ“‹ Factures traitÃ©es dans ce lot</h2>
  <div class="overflow-x-auto bg-white rounded-xl shadow-sm border">
    <table class="w-full text-left border-collapse">
      <thead class="bg-gray-50 text-xs uppercase text-gray-500 font-bold">
        <tr>
          <th class="px-4 py-3 border-b">NÂ° Facture</th>
          <th class="px-4 py-3 border-b">Date</th>
          <th class="px-4 py-3 border-b">RÃ©f. PDR / Commande</th>
          <th class="px-4 py-3 border-b">Fournisseur</th>
          <th class="px-4 py-3 border-b text-right">HT</th>
          <th class="px-4 py-3 border-b text-right">TVA</th>
          <th class="px-4 py-3 border-b text-right">TTC</th>
          <th class="px-4 py-3 border-b text-center">Type</th>
        </tr>
      </thead>
      <tbody id="batchBody" class="divide-y text-sm">
        </tbody>
    </table>
  </div>
</div>

      </div>
    </div>
  </div>

  <!-- Modal Gestion Comptes -->
  <div id="accountModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
      <h2 id="modalTitle" class="text-2xl font-bold mb-4"></h2>
      
      <div class="mb-4">
        <h3 class="font-semibold mb-2">Ajouter un compte</h3>
        <div class="flex gap-2">
          <input type="text" id="newAccountCode" placeholder="Code (ex: 606110)" class="flex-1 px-3 py-2 border rounded-lg">
          <input type="text" id="newAccountLabel" placeholder="LibellÃ©" class="flex-1 px-3 py-2 border rounded-lg">
          <button onclick="addNewAccount()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
            Ajouter
          </button>
        </div>
      </div>

      <div class="mb-4">
        <h3 class="font-semibold mb-2">Comptes existants</h3>
        <div id="accountsList" class="space-y-2"></div>
      </div>

      <button onclick="closeAccountManager()" class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
        Fermer
      </button>
    </div>
  </div>

  <script>
    let extractedData = null;
    let accountEntries = [];
    let currentAccountType = null;
    let selectedFiles = [];

    // ğŸ†• FONCTIONS DE GESTION DES COMPTES
    function openAccountManager(type) {
      currentAccountType = type;
      const modal = document.getElementById('accountModal');
      const title = document.getElementById('modalTitle');
      
      const titles = {
        'charge': 'ğŸ’¼ Gestion des Comptes de Charges',
        'fournisseur': 'ğŸ¢ Gestion des Comptes Fournisseurs',
        'tva': 'ğŸ“Š Gestion des Comptes TVA'
      };
      
      title.textContent = titles[type] || 'Gestion des comptes';
      displayAccountsList();
      modal.classList.remove('hidden');
    }
    
    function closeAccountManager() {
      document.getElementById('accountModal').classList.add('hidden');
      currentAccountType = null;
      document.getElementById('newAccountCode').value = '';
      document.getElementById('newAccountLabel').value = '';
    }
    
    function displayAccountsList() {
      const listDiv = document.getElementById('accountsList');
      let accounts = [];
      
      if (currentAccountType === 'charge') accounts = comptesCharges;
      else if (currentAccountType === 'fournisseur') accounts = comptesFournisseurs;
      else if (currentAccountType === 'tva') accounts = comptesTVA;
      
      listDiv.innerHTML = accounts.map((acc, idx) => `
        <div class="flex items-center justify-between p-2 bg-gray-50 rounded border">
          <div class="flex-1">
            <span class="font-mono font-semibold text-sm">${acc.code}</span>
            <span class="text-gray-600 text-sm ml-3">${acc.label}</span>
          </div>
          <button onclick="deleteAccount(${idx})" class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs">
            ğŸ—‘ï¸
          </button>
        </div>
      `).join('');
    }
    
    function addNewAccount() {
      const code = document.getElementById('newAccountCode').value.trim();
      const label = document.getElementById('newAccountLabel').value.trim();
      
      if (!code || !label) {
        alert('âš ï¸ Veuillez renseigner le code et le libellÃ©');
        return;
      }
      
      if (currentAccountType === 'charge') {
        comptesCharges.push({ code, label });
        comptesCharges.sort((a, b) => a.code.localeCompare(b.code));
      } else if (currentAccountType === 'fournisseur') {
        comptesFournisseurs.push({ code, label });
        comptesFournisseurs.sort((a, b) => a.code.localeCompare(b.code));
      } else if (currentAccountType === 'tva') {
        comptesTVA.push({ code, label });
      }
      
      document.getElementById('newAccountCode').value = '';
      document.getElementById('newAccountLabel').value = '';
      displayAccountsList();
      alert('âœ… Compte ajoutÃ© avec succÃ¨s');
    }
    
    function deleteAccount(index) {
      if (!confirm('âš ï¸ Supprimer ce compte ?')) return;
      
      if (currentAccountType === 'charge') {
        comptesCharges.splice(index, 1);
      } else if (currentAccountType === 'fournisseur') {
        comptesFournisseurs.splice(index, 1);
      } else if (currentAccountType === 'tva') {
        comptesTVA.splice(index, 1);
      }
      
      displayAccountsList();
      alert('âœ… Compte supprimÃ©');
    }
    
    function getAccountsByType(type) {
      if (type === 'charge') return comptesCharges;
      if (type === 'fournisseur') return comptesFournisseurs;
      if (type === 'tva') return comptesTVA;
      return [];
    }
    
function updateAccount(index, compte) {
      accountEntries[index].compte = compte;
      console.log(`Compte ${index} mis Ã  jour:`, compte);
    }
    
    // ğŸ†• FONCTION AVEC RAFRAICHISSEMENT VISUEL
    function updateAccountAndRefresh(index, compte) {
      accountEntries[index].compte = compte;
      
      // RafraÃ®chir visuellement le select
      const selectElement = document.getElementById(`account-select-${index}`);
      if (selectElement) {
        if (compte) {
          selectElement.classList.remove('border-red-300', 'bg-red-50');
          selectElement.classList.add('border-green-300', 'bg-green-50');
          
          // Message de confirmation temporaire
          const row = selectElement.closest('tr');
          const originalBg = row.className;
          row.className = 'border-t bg-green-100';
          setTimeout(() => {
            row.className = originalBg;
          }, 500);
        } else {
          selectElement.classList.remove('border-green-300', 'bg-green-50');
          selectElement.classList.add('border-red-300', 'bg-red-50');
        }
      }
      
      console.log(`âœ… Compte ligne ${index + 1} modifiÃ©: ${compte}`);
    }

    let comptesCharges = [
      { code: '601000', label: 'FR - MP & Serv. INDUCTEURS' },
      { code: '601001', label: 'FR - MP PDR' },
      { code: '601002', label: 'FR - SERVICE TSE' },
      { code: '601003', label: 'FR - MP GHFR STOCK' },
      { code: '601004', label: 'FR - MP RETROFIT' },
      { code: '601005', label: 'FR - GENERATEURS ET EQUIPEMENTS' },
      { code: '601100', label: 'UE - MP INDUCTEURS' },
      { code: '601101', label: 'UE - MP INDUCTEURS GHE' },
      { code: '601102', label: 'UE - GENERATEURS ET EQUIPEMENTS GHE' },
      { code: '601103', label: 'UE - SERVICES' },
      { code: '601104', label: 'UE - SERVICES GHE' },
      { code: '601105', label: 'UE - PIECES DE RECHANGE' },
      { code: '601106', label: 'UE - PIECES DE RECHANGE GHE' },
      { code: '601107', label: 'UE - RETROFIT' },
      { code: '601108', label: 'UE - RETROFIT GHE' },
      { code: '601109', label: 'UE - MP GHFR STOCK' },
      { code: '601200', label: 'HORS UE - PDR' },
      { code: '601210', label: 'HORS UE - SERVICE' },
      { code: '604000', label: 'ACHATS ETUDES & PS - AUTOLI' },
      { code: '604100', label: 'ACHATS ETUDES & PS 20%' },
      { code: '604200', label: 'ACHATS ETUDES & PS TTC' },
      { code: '606110', label: 'ElectricitÃ© 20%' },
      { code: '606115', label: 'ElectricitÃ© 5.5%' },
      { code: '606130', label: 'Eau' },
      { code: '606150', label: 'CARBURANT TTC' },
      { code: '606160', label: 'CARBURANTS - GAS-OIL DED 80%' },
      { code: '606161', label: 'CARBURANT GO INTRACOM' },
      { code: '606162', label: 'AMS - CARBURANT - GAS-OIL DED 80%' },
      { code: '606170', label: 'ATM - CARBURANTS - GAS-OIL TTC' },
      { code: '606171', label: 'ATM - CARBURANTS GAS-OIL DED 80%' },
      { code: '606172', label: 'ATM - CARBURANTS GO INTRACOM' },
      { code: '606300', label: 'Fournit. entretien & petit Ã©quip.' },
      { code: '606310', label: 'Four, entret. pt. mat. ttc' },
      { code: '606320', label: 'FOURN. ENTRET ET EQUIP INTRACO' },
      { code: '606330', label: 'Fourni. entretien & petit Ã©quip 10%' },
      { code: '606340', label: 'Fournit, entretien & petit Ã©qui 5,5%' },
      { code: '606420', label: 'FOURNITURE ADMINISTRATIVE INTR' },
      { code: '612201', label: 'APOLLO - CB LAND ROVER' },
      { code: '613200', label: 'Locations immobiliÃ¨res' },
      { code: '613507', label: 'SAET - location HD-918-BW' },
      { code: '613508', label: 'LOCATION SKODA GT-440-FT' },
      { code: '613509', label: 'LOCATION BMW GM-510-XM GHFR' },
      { code: '613510', label: 'LOCATION HD-005-BX GHFR' },
      { code: '613511', label: 'LOCAT PEUGEOT 308 GK-537-LR GHFR' },
      { code: '613512', label: 'ATM - LOCATION HYUNDAI GK-194-QL' },
      { code: '613513', label: 'LOCATION VOITURE TTC' },
      { code: '613520', label: 'Location bouteilles - GAZ' },
      { code: '613530', label: 'Location Logiciel SAGE' },
      { code: '613540', label: 'Location solution N2F' },
      { code: '613800', label: 'LOCATIONS DIVERSES' },
      { code: '615200', label: 'Sur biens immobiliers' },
      { code: '615529', label: 'APOLLO - ENTRETIEN FD-711-RW' },
      { code: '615530', label: 'ENTRETIEN HD-005-BX' },
      { code: '615531', label: 'ENTRETIEN DN-880-RY' },
      { code: '615532', label: 'ENTRETIEN GM-510-XM' },
      { code: '615533', label: 'ENTRETIEN GT-440-FT' },
      { code: '615540', label: 'ATM - ENTRETIEN GK-194-QL' },
      { code: '615550', label: 'AMS - ENTRETIEN GK-537-LR' },
      { code: '615600', label: 'Maintenance' },
      { code: '622600', label: 'Honoraires' },
      { code: '622601', label: 'Honoraires juridiques' },
      { code: '622700', label: 'Frais d\'actes et de contentieux' },
      { code: '624100', label: 'TRANSPORT SUR ACHAT INTRACOM' },
      { code: '624110', label: 'Transport sur achat 20%' },
      { code: '624130', label: 'TRANSPORT DE MARCHANDISE 20%' },
      { code: '624140', label: 'TRANSPORT DE MARCHANDISE HORS CEE' },
      { code: '624200', label: 'TRANSPORT SUR ACHAT 20%' },
      { code: '625100', label: 'Voyages et dÃ©placements' },
      { code: '625105', label: 'AMS - VOYAGE ET DEPLACEMENT TTC' },
      { code: '625106', label: 'AMS - VOYAGE ET DEPLACEMENT 20%' },
      { code: '625107', label: 'AMS - VOYAGE ET DEPLACEMENT 10%' },
      { code: '625109', label: 'AMS - VOYAGE ET DEPLACEMENT INTRACOM' },
      { code: '625110', label: 'GHFR - VOYAGES ET DEPLACEMENTS 10%' },
      { code: '625111', label: 'GHFR - VOYAGES ET DEPLACEMENTS TTC' },
      { code: '625112', label: 'GHFR - VOYAGE ET DEPLACEMENT INTRACOM' },
      { code: '625114', label: 'GHFR - VOYAGE ET DEPLCAEMENT 20%' },
      { code: '625115', label: 'ATM - VOYAGE ET DEPLACEMENT TTC' },
      { code: '625116', label: 'ATM - VOYAGE ET DEPLACEMENT 20%' },
      { code: '625117', label: 'ATM - VOYAGE ET DEPLACEMENT 10%' },
      { code: '625119', label: 'ATM - VOYAGE ET DEPLACEMENT INTRACOM' },
      { code: '625120', label: 'GHFR - PEAGES 20%' },
      { code: '625121', label: 'ATM - PEAGE 20%' },
      { code: '625123', label: 'ATM - PEAGE TTC' },
      { code: '625125', label: 'SAET - VOYAGE ET DEPLACEMENT TTC' },
      { code: '625700', label: 'RESTAURANT 20%' },
      { code: '625710', label: 'RESTAURANT 10%' },
      { code: '625711', label: 'RESTAURANT 5,5%' },
      { code: '626000', label: 'Frais postaux' },
      { code: '626001', label: 'Frais postaux TTC' },
    ];

    let comptesFournisseurs = [
      { code: '4010AA', label: 'AALBERTS' },
      { code: '4010AC', label: 'ACM COTISATION ASSURANCE' },
      { code: '4010AE', label: 'AREAS ASSURANCES' },
      { code: '4010AI', label: 'AIR TECHNIQUES' },
      { code: '4010AK', label: 'AJAX TOCCO Magnethermic UK' },
      { code: '4010AM', label: 'AMAZON' },
      { code: '4010AR', label: 'AIR PRODUCTS' },
      { code: '4010AS', label: 'ASTE' },
      { code: '4010AT', label: 'ATM WARREN' },
      { code: '4010AV', label: 'ARVAL' },
      { code: '4010AY', label: 'AYVENS' },
      { code: '4010BA', label: 'BAUMANN' },
      { code: '4010BC', label: 'BECHTLE' },
      { code: '4010BD', label: 'BRICO DEPOT' },
      { code: '4010BN', label: 'BINOMI' },
      { code: '4010BO', label: 'BOUYGUES' },
      { code: '4010BV', label: 'BUREAU VERITAS' },
      { code: '4010BX', label: 'BENE INOX' },
      { code: '4010CA', label: 'CAEN ESPACE AFFAIRE' },
      { code: '4010CB', label: 'CB' },
      { code: '4010CC', label: 'CCI CAMPUS' },
      { code: '4010CD', label: 'Coeur de foyer' },
      { code: '4010CI', label: 'CIC LEASING' },
      { code: '4010CO', label: 'CO-PILOTES' },
      { code: '4010CP', label: 'CHRONOPOST' },
      { code: '4010CS', label: 'CARBOSYSTEM' },
      { code: '4010CT', label: 'CASTOLIN EUTECTIC' },
      { code: '4010CV', label: 'CEVA' },
      { code: '4010DH', label: 'DHL EXPRESS' },
      { code: '4010EC', label: 'ESTEVAN CALVO' },
      { code: '4010ED', label: 'EDF' },
      { code: '4010EF', label: 'EFRAPO' },
      { code: '4010EG', label: 'EGLINSDOERFER PFOHL' },
      { code: '4010EM', label: 'EMG PRESSE' },
      { code: '4010ET', label: 'ELECTRO-RHIN' },
      { code: '4010EV', label: 'ECOVIS' },
      { code: '4010EX', label: 'COLMARIENNE DES EAUX' },
      { code: '4010FD', label: 'FOURNISSEURS DIVERS' },
      { code: '4010FE', label: 'FRANCE EXPRESS' },
      { code: '4010FI', label: 'FIDUCIAL' },
      { code: '4010FN', label: 'FINAL AM' },
      { code: '4010FR', label: 'FREE' },
      { code: '4010GA', label: 'GH GERMANY' },
      { code: '4010GC', label: 'GROSCLAUDE ROBIN' },
      { code: '4010GH', label: 'GH ELECTROTHERMIA' },
      { code: '4010GI', label: 'GH INDUCTION ATMOSPHERES' },
      { code: '4010GL', label: 'GL EVENTS' },
      { code: '4010GM', label: 'G.MAIER' },
      { code: '4010GP', label: 'GROUPE ADF' },
      { code: '4010GR', label: 'GREFFE DU TRIBUNAL' },
      { code: '4010GU', label: 'GUS EI' },
      { code: '4010HA', label: 'Hanna Instrumments' },
      { code: '4010IC', label: 'ICM' },
      { code: '4010IG', label: 'INFOGREFFE' },
      { code: '4010IO', label: 'IONOS' },
      { code: '4010KL', label: 'KILOUTOU' },
      { code: '4010LD', label: 'LAUDA' },
      { code: '4010LE', label: 'LECLERC' },
      { code: '4010LS', label: 'LetMeShip' },
      { code: '4010ME', label: 'MEDIACO' },
      { code: '4010MG', label: 'MATRIGALSA' },
      { code: '4010ML', label: 'MOLDES 2010' },
      { code: '4010MT', label: 'MÃ©decine travail' },
      { code: '4010NC', label: 'NDF CONRAUD' },
      { code: '4010ND', label: 'NDF DIVERS' },
      { code: '4010NF', label: 'N2F' },
      { code: '4010NH', label: 'NHP' },
      { code: '4010NJ', label: 'NDF POURCHAUX' },
      { code: '4010NM', label: 'NDF MARQUIS' },
      { code: '4010NO', label: 'NOVAPLEST' },
      { code: '4010NP', label: 'NDF PATARD' },
      { code: '4010NS', label: 'NDF CARRIERE' },
      { code: '4010NT', label: 'NDF THOMAS' },
      { code: '4010NV', label: 'NDF BUFFENOIR' },
      { code: '4010OR', label: 'ORANGE' },
      { code: '4010PE', label: 'PEAGE' },
      { code: '4010PS', label: 'LA POSTE' },
      { code: '4010PT', label: 'PROTEVAL' },
      { code: '4010RS', label: 'RS' },
      { code: '4010SB', label: 'STAUBLI' },
      { code: '4010SC', label: 'SCI DIKATES' },
      { code: '4010SG', label: 'SAGE' },
      { code: '4010ST', label: 'SEIT ELETTRONICA' },
      { code: '4010SU', label: 'SUEZ' },
      { code: '4010TL', label: 'TALLERES IRANZO' },
      { code: '4010TM', label: 'TM INDUSTRY' },
      { code: '4010TN', label: 'TNT FEDEX' },
      { code: '4010TS', label: 'TRANSPORT' },
      { code: '4010UL', label: 'ULYS' },
      { code: '4010VC', label: 'VOCA CONSEIL' },
      { code: '4010ZG', label: 'ZIEGLER' },
    ];

    let comptesTVA = [
      { code: '445662', label: 'Taux rÃ©duit' },
      { code: '445666', label: 'Taux intermÃ©diaire' },
      { code: '445667', label: 'TVA dÃ©ductible 20%' },
      { code: '445668', label: 'TVA dÃ©ductible Intracomm' },
      { code: '445200', label: 'TVA collectÃ©e Intracomm' },
    ];

    function saveApiKey() {
      const key = document.getElementById('apiKey').value.trim();
      if (!key) {
        alert('âš ï¸ Veuillez entrer une clÃ© API');
        return;
      }
      if (!key.startsWith('AIza')) {
        alert('âš ï¸ Format de clÃ© invalide. Une clÃ© Gemini commence par "AIza"');
        return;
      }
      localStorage.setItem('gemini_api_key', key);
      alert('âœ… ClÃ© API sauvegardÃ©e avec succÃ¨s !');
    }

    function loadApiKey() {
      const key = localStorage.getItem('gemini_api_key');
      if (key) {
        document.getElementById('apiKey').value = key;
      }
    }

    window.addEventListener('DOMContentLoaded', loadApiKey);

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

// ğŸ†• Permettre le clic sur la zone
dropZone.addEventListener('click', () => {
  fileInput.click();
});

// ğŸ†• Feedback visuel au survol
dropZone.ondragover = (e) => {
  e.preventDefault();
  e.stopPropagation();
  dropZone.classList.add('border-blue-500', 'bg-blue-100');
};

// ğŸ†• Retirer le feedback quand on sort
dropZone.ondragleave = (e) => {
  e.preventDefault();
  e.stopPropagation();
  dropZone.classList.remove('border-blue-500', 'bg-blue-100');
};

dropZone.ondrop = (e) => {
  e.preventDefault();
  e.stopPropagation();
  dropZone.classList.remove('border-blue-500', 'bg-blue-100'); // ğŸ†• Retirer feedback
  
  console.log('[DROP ZONE] Fichiers dÃ©posÃ©s');
  const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
  console.log('[DROP ZONE] Fichiers PDF trouvÃ©s:', files.length);
  
  if (files.length > 0) {
    selectedFiles = files;
    console.log('[DROP ZONE] selectedFiles mis Ã  jour:', selectedFiles);
    displayFilesList();
  } else {
    alert('âš ï¸ Veuillez sÃ©lectionner uniquement des fichiers PDF'); // ğŸ†• Alerte utilisateur
  }
};

fileInput.onchange = (e) => {
  console.log('[FILE INPUT] Changement dÃ©tectÃ©');
  const files = Array.from(e.target.files).filter(f => f.type === 'application/pdf');
  console.log('[FILE INPUT] Fichiers PDF trouvÃ©s:', files.length);
  
  if (files.length > 0) {
    selectedFiles = files;
    console.log('[FILE INPUT] selectedFiles mis Ã  jour:', selectedFiles);
    displayFilesList();
  } else {
    alert('âš ï¸ Veuillez sÃ©lectionner uniquement des fichiers PDF'); // ğŸ†• Alerte utilisateur
  }
};
    function displayFilesList() {
  const listDiv = document.getElementById('filesListContent');
  listDiv.innerHTML = selectedFiles.map((file, index) => `
    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
      <div class="flex items-center gap-3">
        <span class="text-2xl">ğŸ“„</span>
        <div>
          <p class="font-medium text-gray-800">${file.name}</p>
          <p class="text-xs text-gray-500">${(file.size / 1024).toFixed(0)} KB</p>
        </div>
      </div>
      <button onclick="removeFile(${index})" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm">
        Retirer
      </button>
    </div>
  `).join('');
  
  document.getElementById('filesList').classList.remove('hidden');
  document.getElementById('results').classList.add('hidden');
}

function removeFile(index) {
  selectedFiles.splice(index, 1);
  if (selectedFiles.length === 0) {
    document.getElementById('filesList').classList.add('hidden');
    document.getElementById('fileName').textContent = '';
  } else {
    displayFilesList();
  }
}

// ğŸ†• Variable globale pour annulation
let isProcessingCancelled = false;

async function processAllFiles() {
  console.log('[PROCESS] ğŸš€ DÃ©but du traitement batch');
  
  if (selectedFiles.length === 0) {
    console.error('[PROCESS] âŒ selectedFiles est vide');
    alert('âš ï¸ Aucun fichier sÃ©lectionnÃ©');
    return;
  }

  const apiKey = localStorage.getItem('gemini_api_key');
  console.log('[PROCESS] ğŸ”‘ ClÃ© API:', apiKey ? apiKey.substring(0, 15) + '...' : 'MANQUANTE');
  
  if (!apiKey) {
    alert('âš ï¸ Veuillez configurer votre clÃ© API Gemini');
    return;
  }

  // ğŸ†• RÃ©initialiser le flag d'annulation
  isProcessingCancelled = false;
  
  const loadingDiv = document.getElementById('loading');
  loadingDiv.classList.remove('hidden');
  document.getElementById('filesList').classList.add('hidden');
  
  // ğŸ†• Ajouter bouton annuler
  const progressDiv = document.getElementById('progressText');
  progressDiv.innerHTML = `
    Traitement de 0/${selectedFiles.length}: DÃ©marrage...
    <br>
    <button onclick="cancelProcessing()" class="mt-3 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">
      âŒ Annuler le traitement
    </button>
  `;
  
  let allInvoicesData = [];
  let successCount = 0;
  let errorCount = 0;
  let errorDetails = []; // ğŸ†• Stocker les dÃ©tails des erreurs

  console.log(`[PROCESS] ğŸ“Š ${selectedFiles.length} fichier(s) Ã  traiter`);

  for (let i = 0; i < selectedFiles.length; i++) {
    // ğŸ†• VÃ©rifier si annulation demandÃ©e
    if (isProcessingCancelled) {
      console.log('[PROCESS] ğŸ›‘ Traitement annulÃ© par l\'utilisateur');
      alert(`âš ï¸ Traitement annulÃ© !\n${successCount} factures traitÃ©es avant annulation`);
      break;
    }
    
    const file = selectedFiles[i];
    
    // ğŸ†• Calcul du pourcentage
    const percentage = Math.round(((i + 1) / selectedFiles.length) * 100);
    
    progressDiv.innerHTML = `
      <div class="mb-2">
        <div class="flex justify-between text-sm mb-1">
          <span>Traitement de ${i + 1}/${selectedFiles.length}: ${file.name}</span>
          <span>${percentage}%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
          <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
        </div>
      </div>
      <button onclick="cancelProcessing()" class="mt-3 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">
        âŒ Annuler le traitement
      </button>
    `;

    console.log(`[PROCESS] ğŸ“„ [${i + 1}/${selectedFiles.length}] Traitement: ${file.name}`);

    try {
      const invoiceData = await analyzeInvoiceForBatch(file, apiKey);
      
      if (invoiceData) {
        allInvoicesData.push(invoiceData);
        successCount++;
        console.log(`[PROCESS] âœ… [${i + 1}/${selectedFiles.length}] SuccÃ¨s: ${file.name}`);
      } else {
        errorCount++;
        errorDetails.push({ file: file.name, error: 'Aucune donnÃ©e retournÃ©e' }); // ğŸ†•
        console.warn(`[PROCESS] âš ï¸ [${i + 1}/${selectedFiles.length}] Aucune donnÃ©e: ${file.name}`);
      }
      
      // ğŸ†• Pause adaptative selon le nombre de fichiers
      if (i < selectedFiles.length - 1) {
        const pauseDuration = selectedFiles.length > 10 ? 1000 : 2000;
        console.log(`[PROCESS] â³ Pause ${pauseDuration}ms...`);
        await new Promise(resolve => setTimeout(resolve, pauseDuration));
      }
    } catch (error) {
      console.error(`[PROCESS] âŒ [${i + 1}/${selectedFiles.length}] Erreur:`, error);
      errorCount++;
      errorDetails.push({ file: file.name, error: error.message }); // ğŸ†•
    }
  }

  loadingDiv.classList.add('hidden');
  console.log(`[PROCESS] ğŸ TerminÃ©: ${successCount} succÃ¨s, ${errorCount} erreurs`);
  
  if (allInvoicesData.length > 0) {
    console.log('[PROCESS] ğŸ“Š Affichage des rÃ©sultats...');
    displayBatchResults(allInvoicesData);
    
    // ğŸ†• Message dÃ©taillÃ© avec les erreurs
    let message = `âœ… Traitement terminÃ© !\n\n${successCount} factures traitÃ©es avec succÃ¨s`;
    if (errorCount > 0) {
      message += `\n${errorCount} erreurs:\n`;
      errorDetails.forEach(err => {
        message += `\nâ€¢ ${err.file}: ${err.error}`;
      });
    }
    message += `\n\nVÃ©rifiez les rÃ©sultats ci-dessous avant d'exporter.`;
    alert(message);
  } else {
    console.error('[PROCESS] âŒ Aucune facture traitÃ©e avec succÃ¨s');
    
    // ğŸ†• Afficher les erreurs dÃ©taillÃ©es
    let errorMsg = 'âŒ Aucune facture n\'a pu Ãªtre traitÃ©e\n\nErreurs dÃ©tectÃ©es:\n';
    errorDetails.forEach(err => {
      errorMsg += `\nâ€¢ ${err.file}: ${err.error}`;
    });
    alert(errorMsg);
  }
  
  selectedFiles = [];
  console.log('[PROCESS] ğŸ§¹ selectedFiles rÃ©initialisÃ©');
}

// ğŸ†• Fonction d'annulation
function cancelProcessing() {
  if (confirm('âš ï¸ Voulez-vous vraiment annuler le traitement en cours ?')) {
    isProcessingCancelled = true;
  }
}
    function generateEntriesForInvoice(inv) {
  const entries = [];
  const isAvoir = inv.est_avoir || inv.montant_ht < 0;
  const isIntracomm = inv.est_intracomm === true;
  
  // Extraction PDR
  let referencePDR = null;
  if (inv.description) {
    const match = inv.description.match(/PDR-\d{2}-\d{4}/i);
    if (match) referencePDR = match[0].toUpperCase();
  }
  if (!referencePDR && inv.reference_interne) {
    const match = inv.reference_interne.match(/PDR-\d{2}-\d{4}/i);
    if (match) referencePDR = match[0].toUpperCase();
  }
  
  const libelle = referencePDR || inv.reference_interne || inv.fournisseur;
  
  if (isAvoir) {
    const montantHTAvoir = Math.abs(inv.montant_ht);
    const montantTVAAvoir = Math.abs(inv.montant_tva);
    const montantTTCAvoir = Math.abs(inv.montant_ttc);
    
    entries.push(
      { accountType: 'fournisseur', compte: '4010FD', montant: montantTTCAvoir.toFixed(2), sens: 'D', libelle },
      { accountType: 'charge', compte: '601000', montant: montantHTAvoir.toFixed(2), sens: 'C', libelle },
      { accountType: 'tva', compte: '445667', montant: montantTVAAvoir.toFixed(2), sens: 'C', libelle }
    );
  } else if (isIntracomm) {
    const tvaIntra = (inv.montant_ht * 0.20).toFixed(2);
    entries.push(
      { accountType: 'charge', compte: '601100', montant: inv.montant_ht.toFixed(2), sens: 'D', libelle },
      { accountType: 'tva', compte: '445668', montant: tvaIntra, sens: 'D', libelle },
      { accountType: 'tva', compte: '445200', montant: tvaIntra, sens: 'C', libelle },
      { accountType: 'fournisseur', compte: '4010FD', montant: inv.montant_ht.toFixed(2), sens: 'C', libelle }
    );
  } else {
    entries.push(
      { accountType: 'charge', compte: '606110', montant: inv.montant_ht.toFixed(2), sens: 'D', libelle },
      { accountType: 'tva', compte: '445667', montant: inv.montant_tva.toFixed(2), sens: 'D', libelle },
      { accountType: 'fournisseur', compte: '4010FD', montant: inv.montant_ttc.toFixed(2), sens: 'C', libelle }
    );
  }
  
  return entries;
}

function updateLibelle(numFacture, entryIndex, newLibelle) {
  const inv = window.batchInvoicesData.find(i => i.numero_facture === numFacture);
  if (!inv) return;
  
  if (!inv.customLibelles) inv.customLibelles = {};
  inv.customLibelles[entryIndex] = newLibelle;
  console.log(`LibellÃ© mis Ã  jour pour ${numFacture}:`, newLibelle);
}
function displayBatchResults(allInvoicesData) {
  document.getElementById('results').classList.remove('hidden');
  
  // ğŸ†• Calcul des totaux
  const totalHT = allInvoicesData.reduce((sum, inv) => sum + inv.montant_ht, 0);
  const totalTVA = allInvoicesData.reduce((sum, inv) => sum + inv.montant_tva, 0);
  const totalTTC = allInvoicesData.reduce((sum, inv) => sum + inv.montant_ttc, 0);
  
  const html = `
    <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-4">
      <h3 class="font-semibold text-green-800 mb-2">ğŸ“Š RÃ©sultats du traitement batch</h3>
      <p class="text-sm text-green-700">${allInvoicesData.length} facture(s) analysÃ©e(s)</p>
      <div class="grid grid-cols-3 gap-4 mt-3 text-sm">
        <div><span class="text-green-600">Total HT:</span> <strong>${totalHT.toFixed(2)} â‚¬</strong></div>
        <div><span class="text-green-600">Total TVA:</span> <strong>${totalTVA.toFixed(2)} â‚¬</strong></div>
        <div><span class="text-green-600">Total TTC:</span> <strong>${totalTTC.toFixed(2)} â‚¬</strong></div>
      </div>
    </div>
    
    <div class="space-y-4 mb-6">
      ${allInvoicesData.map((inv, idx) => `
        <div class="border rounded-lg p-4 ${inv.est_intracomm ? 'bg-blue-50 border-blue-200' : 'bg-gray-50'} relative">
          <button onclick="removeInvoiceFromBatch(${idx})" 
                  class="absolute top-2 right-2 px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs">
            ğŸ—‘ï¸ Supprimer
          </button>
          
          <div class="flex justify-between items-start mb-3 pr-24">
            <div>
              <h4 class="font-semibold text-lg">${idx + 1}. ${inv.fournisseur}</h4>
              <p class="text-sm text-gray-600">${inv.filename}</p>
            </div>
            <div class="text-right">
              <p class="font-bold text-lg">${inv.montant_ttc.toFixed(2)} â‚¬</p>
              <p class="text-xs text-gray-500">TTC</p>
            </div>
          </div>
          
          <div class="grid grid-cols-4 gap-3 text-sm">
            <div><span class="text-gray-500">NÂ° Facture:</span> <strong>${inv.numero_facture}</strong></div>
            <div><span class="text-gray-500">Date:</span> <strong>${formatDate(inv.date)}</strong></div>
            <div><span class="text-gray-500">HT:</span> <strong>${inv.montant_ht.toFixed(2)} â‚¬</strong></div>
            <div><span class="text-gray-500">TVA ${inv.tva_taux}%:</span> <strong>${inv.montant_tva.toFixed(2)} â‚¬</strong></div>
          </div>
          
          <div class="mt-3 flex gap-2">
            ${inv.est_intracomm ? '<span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold">ğŸ‡ªğŸ‡º INTRACOMMUNAUTAIRE</span>' : ''}
            ${inv.est_avoir ? '<span class="inline-block px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs font-semibold">ğŸ“„ AVOIR</span>' : ''}
            <button onclick="previewInvoiceEntries(${idx})" 
                    class="ml-auto px-3 py-1 bg-indigo-500 text-white rounded hover:bg-indigo-600 text-xs">
              ğŸ‘ï¸ PrÃ©visualiser Ã©critures
            </button>
          </div>
        </div>
      `).join('')}
    </div>
    
    <div class="flex gap-4">
      <button onclick="confirmAndExportBatch()" 
              class="flex-1 px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold">
        ğŸ’¾ Exporter toutes les factures pour N2F / Sage
      </button>
      <button onclick="resetBatch()" 
              class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-semibold">
        ğŸ”„ Recommencer
      </button>
    </div>
  `;
  
  document.getElementById('extractedData').innerHTML = html;
  document.getElementById('entriesTable').innerHTML = '';
  
  window.batchInvoicesData = allInvoicesData;
}

// ğŸ†• Fonction pour formater la date
function formatDate(dateStr) {
  if (dateStr && dateStr.length === 8) {
    const year = dateStr.substring(0, 4);
    const month = dateStr.substring(4, 6);
    const day = dateStr.substring(6, 8);
    return `${day}/${month}/${year}`;
  }
  return dateStr;
}

// ğŸ†• Fonction pour supprimer une facture
function removeInvoiceFromBatch(index) {
  if (!confirm('âš ï¸ Supprimer cette facture du lot ?')) return;
  
  window.batchInvoicesData.splice(index, 1);
  
  if (window.batchInvoicesData.length === 0) {
    document.getElementById('results').classList.add('hidden');
    alert('âœ… Toutes les factures ont Ã©tÃ© retirÃ©es');
  } else {
    displayBatchResults(window.batchInvoicesData);
    alert('âœ… Facture supprimÃ©e');
  }
}

function previewInvoiceEntries(index) {
  const inv = window.batchInvoicesData[index];
  
  // ğŸ”§ CORRECTION 1: GÃ©nÃ©rer les vraies Ã©critures
  const previousData = extractedData;
  extractedData = inv;
  generateEntries();
  
  const entries = accountEntries.map(e => ({
    type: e.accountType === 'charge' ? 'Charge' : 
          e.accountType === 'fournisseur' ? 'Fournisseur' : 'TVA',
    compte: e.compte || 'âš ï¸ NON DÃ‰FINI',
    montant: e.montant,
    sens: e.sens
  }));
  
  extractedData = previousData;
  if (extractedData) generateEntries();
  
  const entriesHtml = entries.map(e => 
    `<tr class="border-t">
      <td class="px-3 py-2 text-sm">${e.type}</td>
      <td class="px-3 py-2 font-mono text-sm">${e.compte}</td>
      <td class="px-3 py-2 text-right font-semibold">${e.montant} â‚¬</td>
      <td class="px-3 py-2 text-center">
        <span class="px-2 py-1 rounded text-xs ${e.sens === 'D' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
          ${e.sens}
        </span>
      </td>
    </tr>`
  ).join('');
  
  const modalHtml = `
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="this.remove()">
      <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">ğŸ“‹ Ã‰critures pour ${inv.fournisseur}</h3>
        <p class="text-sm text-gray-600 mb-4">Facture ${inv.numero_facture} - ${formatDate(inv.date)}</p>
        
        <table class="w-full border">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-3 py-2 text-left">Type</th>
              <th class="px-3 py-2 text-left">Compte</th>
              <th class="px-3 py-2 text-right">Montant</th>
              <th class="px-3 py-2 text-center">D/C</th>
            </tr>
          </thead>
          <tbody>
            ${entriesHtml}
          </tbody>
        </table>
        
        <button onclick="this.closest('.fixed').remove()" 
                class="mt-6 w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
          Fermer
        </button>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// ğŸ†• Fonction pour recommencer
function resetBatch() {
  if (!confirm('âš ï¸ Effacer tous les rÃ©sultats et recommencer ?')) return;
  
  window.batchInvoicesData = [];
  document.getElementById('results').classList.add('hidden');
  document.getElementById('filesList').classList.add('hidden');
  selectedFiles = [];
  fileInput.value = '';
}

function confirmAndExportBatch() {
  if (!window.batchInvoicesData || window.batchInvoicesData.length === 0) {
    alert('âŒ Aucune donnÃ©e Ã  exporter');
    return;
  }
  
  const count = window.batchInvoicesData.length;
  
  // ğŸ†• VÃ©rification des dates
  const invalidDates = window.batchInvoicesData.filter(inv => 
    !inv.date || inv.date.length !== 8 || isNaN(inv.date)
  );
  
  if (invalidDates.length > 0) {
    alert(`âš ï¸ ${invalidDates.length} facture(s) ont des dates invalides.\nVÃ©rifiez les donnÃ©es avant export.`);
    return;
  }
  
  if (confirm(`ğŸ“¤ Exporter ${count} facture(s) vers N2F/Sage ?\n\nVÃ©rifiez bien vos donnÃ©es avant de confirmer.`)) {
    exportMultipleInvoices(window.batchInvoicesData);
  }
}

function exportMultipleInvoices(allInvoicesData) {
  const code = document.getElementById('codeJournal').value;
  
  if (!code || code.length !== 2) {
    alert('âš ï¸ Le code journal doit contenir exactement 2 caractÃ¨res');
    return;
  }
  
  const removeAccents = (str) => str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  
  let output = '';
  let totalLines = 0;
  
  allInvoicesData.forEach(invoiceData => {
    const numFacture = invoiceData.numero_facture;
    const date = invoiceData.date;
    const isAvoir = invoiceData.est_avoir || invoiceData.montant_ht < 0;
    const isIntracomm = invoiceData.est_intracomm === true;
    
    // ğŸ”§ CORRECTION: GÃ©nÃ©rer les Ã©critures pour CHAQUE facture
    let entries = [];
    
    if (isAvoir) {
      const montantHTAvoir = Math.abs(invoiceData.montant_ht);
      const montantTVAAvoir = Math.abs(invoiceData.montant_tva);
      const montantTTCAvoir = Math.abs(invoiceData.montant_ttc);
      
      entries.push(
        { accountType: 'fournisseur', compte: '4010FD', montant: montantTTCAvoir.toFixed(2), sens: 'D' },
        { accountType: 'charge', compte: '601000', montant: montantHTAvoir.toFixed(2), sens: 'C' },
        { accountType: 'tva', compte: '445667', montant: montantTVAAvoir.toFixed(2), sens: 'C' }
      );
    } else if (isIntracomm) {
      const tvaIntra = (invoiceData.montant_ht * 0.20).toFixed(2);
      entries.push(
        { accountType: 'charge', compte: '601100', montant: invoiceData.montant_ht.toFixed(2), sens: 'D' },
        { accountType: 'tva', compte: '445668', montant: tvaIntra, sens: 'D' },
        { accountType: 'tva', compte: '445200', montant: tvaIntra, sens: 'C' },
        { accountType: 'fournisseur', compte: '4010FD', montant: invoiceData.montant_ht.toFixed(2), sens: 'C' }
      );
    } else {
      entries.push(
        { accountType: 'charge', compte: '606110', montant: invoiceData.montant_ht.toFixed(2), sens: 'D' },
        { accountType: 'tva', compte: '445667', montant: invoiceData.montant_tva.toFixed(2), sens: 'D' },
        { accountType: 'fournisseur', compte: '4010FD', montant: invoiceData.montant_ttc.toFixed(2), sens: 'C' }
      );
    }
    
    // ğŸ”§ CORRECTION: Extraction PDR amÃ©liorÃ©e (chercher partout)
    entries.forEach(e => {
      let referencePDR = null;
      
      // Chercher PDR dans description
      if (invoiceData.description) {
        const match = invoiceData.description.match(/PDR-\d{2}-\d{4}/i);
        if (match) referencePDR = match[0].toUpperCase();
      }
      
      // Chercher dans reference_interne
      if (!referencePDR && invoiceData.reference_interne) {
        const match = invoiceData.reference_interne.match(/PDR-\d{2}-\d{4}/i);
        if (match) referencePDR = match[0].toUpperCase();
      }
      
      // Chercher dans numero_facture
      if (!referencePDR && invoiceData.numero_facture) {
        const match = invoiceData.numero_facture.match(/PDR-\d{2}-\d{4}/i);
        if (match) referencePDR = match[0].toUpperCase();
      }
      
      let libelle = '';
      if (referencePDR) {
        libelle = removeAccents(`${referencePDR} ${invoiceData.fournisseur}`);
      } else if (invoiceData.reference_interne) {
        libelle = removeAccents(`${invoiceData.reference_interne} ${invoiceData.fournisseur}`);
      } else {
        libelle = removeAccents(invoiceData.fournisseur);
      }
      libelle = libelle.substring(0, 25);
      
      let description = '';
      if (referencePDR) {
        description = removeAccents(`${referencePDR} ${invoiceData.fournisseur}`);
      } else if (invoiceData.reference_interne) {
        description = removeAccents(`${invoiceData.reference_interne} ${invoiceData.fournisseur}`);
      } else {
        description = removeAccents(
          e.accountType === 'charge' ? 
            (invoiceData.description || 'Achat') : 
            invoiceData.fournisseur
        );
      }
      description = description.substring(0, 34);
      
      const montantArrondi = Math.round(parseFloat(e.montant) * 100) / 100;
      const montantCentimes = Math.round(montantArrondi * 100);
      
      const line = 
        numFacture.toString().padStart(5, ' ') + ',' +
        code + ',' +
        date + ',' +
        ''.padEnd(20, ' ') + ',' +
        e.compte.padEnd(11, ' ') + ',' +
        libelle.padEnd(25, ' ') + ',' +
        montantCentimes.toString().padStart(13, ' ') + ',' +
        e.sens + ',' +
        ''.padEnd(12, ' ') + ',' +
        ''.padEnd(6, ' ') + ',' +
        description.padEnd(34, ' ') + ',' +
        '\r\n';
      
      output += line;
      totalLines++;
    });
  });

  if (totalLines === 0) {
    alert('âŒ Aucune Ã©criture gÃ©nÃ©rÃ©e');
    return;
  }

  const blob = new Blob([output], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  
  const today = new Date();
  const dateStr = today.getFullYear() + 
                  String(today.getMonth() + 1).padStart(2, '0') + 
                  String(today.getDate()).padStart(2, '0');
  
  a.download = `ExportFile_Batch_${allInvoicesData.length}factures_${dateStr}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  alert(`âœ… Export rÃ©ussi !\n\n${allInvoicesData.length} factures exportÃ©es\n${totalLines} Ã©critures comptables gÃ©nÃ©rÃ©es\n\nFichier: ExportFile_Batch_${allInvoicesData.length}factures_${dateStr}.txt`);
}

async function analyzeInvoiceForBatch(file, apiKey) {
  console.log(`[BATCH] ğŸ”„ DÃ©but analyse: ${file.name}`);
  
  return new Promise((resolve) => {
    const reader = new FileReader();
    
    reader.onload = async () => {
      console.log(`[BATCH] ğŸ“„ Fichier lu: ${file.name}`);
      
      try {
        const base64 = reader.result.split(',')[1];
        console.log(`[BATCH] ğŸ” Base64 longueur: ${base64.length}`);
        
        // ğŸ†• Timeout de 30 secondes
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          signal: controller.signal, // ğŸ†• Ajout signal
          body: JSON.stringify({
            contents: [{
              parts: [
                {
                  text: `Tu es un expert-comptable franÃ§ais. Analyse cette facture avec PRÃ‰CISION MAXIMALE.

âš ï¸ RÃˆGLE ABSOLUE SUR LA TVA :
- Si tu vois un montant de TVA affichÃ© (ex: "TVA 20%: 45,60â‚¬" ou "TVA 10%", etc.) â†’ La facture EST franÃ§aise avec TVA
- Si tu vois "TVA non applicable", "Autoliquidation", "Reverse charge", ou mention pays UE â†’ ALORS c'est intracommunautaire
- JAMAIS les deux en mÃªme temps !

RÃˆGLES D'EXTRACTION :
1. FOURNISSEUR = Ã©metteur de la facture (en-tÃªte du document)
2. Si TVA AFFICHÃ‰E avec montant â†’ tva_taux = le taux indiquÃ© ET est_intracomm = false
3. Si "TVA non applicable" OU fournisseur UE â†’ tva_taux = 0 ET est_intracomm = true
4. Si AVOIR ou montant nÃ©gatif â†’ est_avoir = true

RÃ©ponds UNIQUEMENT avec ce JSON (sans markdown, sans texte) :
{
  "fournisseur": "nom Ã©metteur",
  "numero_facture": "numÃ©ro",
  "date": "AAAAMMJJ",
  "montant_ht": nombre,
  "tva_taux": nombre,
  "montant_tva": nombre,
  "montant_ttc": nombre,
  "description": "description courte",
  "reference_interne": "ref client ou null",
  "categorie_suggeree": "catÃ©gorie",
  "est_intracomm": false,
  "est_avoir": false
}`
                },
                {
                  inline_data: {
                    mime_type: 'application/pdf',
                    data: base64
                  }
                }
              ]
            }],
            generationConfig: {
              temperature: 0,
              maxOutputTokens: 2048
            }
          })
        });

        clearTimeout(timeoutId); // ğŸ†• Nettoyer le timeout
        console.log(`[BATCH] ğŸ“¡ RÃ©ponse API status: ${response.status}`);

        if (!response.ok) {
          const errorText = await response.text();
          console.error(`[BATCH] âŒ Erreur API pour ${file.name}:`, errorText);
          
          // ğŸ†• DÃ©tails d'erreur plus prÃ©cis
          let errorMsg = `Erreur ${response.status}`;
          try {
            const errorJson = JSON.parse(errorText);
            errorMsg = errorJson.error?.message || errorMsg;
          } catch (e) {
            errorMsg = errorText.substring(0, 100);
          }
          
          alert(`âŒ Erreur API pour ${file.name}:\n${errorMsg}`);
          resolve(null);
          return;
        }

        const data = await response.json();
        console.log(`[BATCH] ğŸ“¥ DonnÃ©es reÃ§ues pour ${file.name}`);
        
        // ğŸ†• VÃ©rification de la structure de rÃ©ponse
        if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
          console.error(`[BATCH] âŒ Structure de rÃ©ponse invalide pour ${file.name}:`, data);
          alert(`âŒ RÃ©ponse API invalide pour ${file.name}`);
          resolve(null);
          return;
        }
        
        const text = data.candidates[0].content.parts[0].text;
        const cleanText = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        const jsonMatch = cleanText.match(/\{[\s\S]*\}/);
        
        if (jsonMatch) {
          const invoiceData = JSON.parse(jsonMatch[0]);
          
          // ğŸ†• Validation des champs obligatoires
          const requiredFields = ['fournisseur', 'numero_facture', 'date', 'montant_ht', 'montant_ttc'];
          const missingFields = requiredFields.filter(field => !invoiceData[field]);
          
          if (missingFields.length > 0) {
            console.error(`[BATCH] âŒ Champs manquants pour ${file.name}:`, missingFields);
            alert(`âš ï¸ DonnÃ©es incomplÃ¨tes pour ${file.name}:\nChamps manquants: ${missingFields.join(', ')}`);
            resolve(null);
            return;
          }
          
          // ğŸ†• Valeurs par dÃ©faut pour champs optionnels
          invoiceData.filename = file.name;
          invoiceData.est_intracomm = invoiceData.est_intracomm || false;
          invoiceData.est_avoir = invoiceData.est_avoir || false;
          invoiceData.tva_taux = invoiceData.tva_taux || 0;
          invoiceData.montant_tva = invoiceData.montant_tva || 0;
          
          console.log(`[BATCH] âœ… SuccÃ¨s: ${file.name} - ${invoiceData.fournisseur}`);
          resolve(invoiceData);
        } else {
          console.error(`[BATCH] âŒ Pas de JSON trouvÃ© pour ${file.name}`);
          console.error(`[BATCH] Texte reÃ§u:`, cleanText);
          alert(`âŒ Format de rÃ©ponse invalide pour ${file.name}`);
          resolve(null);
        }
        
      } catch (error) {
        console.error(`[BATCH] âŒ Erreur parsing ${file.name}:`, error);
        
        // ğŸ†• Message d'erreur selon le type
        if (error.name === 'AbortError') {
          alert(`â±ï¸ Timeout pour ${file.name} (>30s)`);
        } else {
          alert(`âŒ Erreur technique pour ${file.name}:\n${error.message}`);
        }
        
        resolve(null);
      }
    };
    
    reader.onerror = (error) => {
      console.error(`[BATCH] âŒ Erreur lecture fichier ${file.name}:`, error);
      alert(`âŒ Impossible de lire ${file.name}`);
      resolve(null);
    };
    
    reader.readAsDataURL(file);
  });
}

function displayResults() {
      // VÃ©rification de sÃ©curitÃ©
      if (!extractedData) {
        console.error('[displayResults] extractedData est null');
        return;
      }
      
      document.getElementById('results').classList.remove('hidden');
      
      const isAvoir = extractedData.est_avoir || extractedData.montant_ht < 0;
      const isIntracomm = extractedData.est_intracomm === true;
      
      document.getElementById('extractedData').innerHTML = `
        <div><p class="text-sm text-gray-500">Fournisseur</p><p class="font-semibold">${extractedData.fournisseur}</p></div>
        <div><p class="text-sm text-gray-500">NÂ° Facture</p><p class="font-semibold">${extractedData.numero_facture}</p></div>
        <div><p class="text-sm text-gray-500">Date</p><p class="font-semibold">${formatDate(extractedData.date)}</p></div>
        ${extractedData.reference_interne ? `<div><p class="text-sm text-gray-500">RÃ©fÃ©rence</p><p class="font-semibold">${extractedData.reference_interne}</p></div>` : ''}
        <div><p class="text-sm text-gray-500">Montant HT</p><p class="font-semibold">${extractedData.montant_ht.toFixed(2)} â‚¬</p></div>
        <div><p class="text-sm text-gray-500">TVA (${extractedData.tva_taux}%)</p><p class="font-semibold">${extractedData.montant_tva.toFixed(2)} â‚¬</p></div>
        <div><p class="text-sm text-gray-500">Montant TTC</p><p class="font-semibold">${extractedData.montant_ttc.toFixed(2)} â‚¬</p></div>
        ${isAvoir ? '<div class="col-span-3"><span class="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm font-semibold">ğŸ“„ AVOIR</span></div>' : ''}
        ${isIntracomm ? '<div class="col-span-3"><span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">ğŸ‡ªğŸ‡º INTRACOMMUNAUTAIRE</span></div>' : ''}
      `;
      
      if (isIntracomm && !isAvoir) {
        document.getElementById('intracommButton').classList.remove('hidden');
      } else {
        document.getElementById('intracommButton').classList.add('hidden');
      }
      
      // ğŸ†• Auto-gÃ©nÃ©rer les Ã©critures
      generateEntries();
    }

function generateEntries() {
      if (!extractedData) {
        console.error('[generateEntries] extractedData est null');
        return;
      }
      
      const numFacture = extractedData.numero_facture || 'ERROR';
      const code = document.getElementById('codeJournal').value;
      const piece = numFacture + code + extractedData.date;
      
      const isAvoir = extractedData.est_avoir || extractedData.montant_ht < 0;
      const isIntracomm = extractedData.est_intracomm === true;
      
      accountEntries = [];
      
      if (isAvoir) {
        const montantHTAvoir = Math.abs(extractedData.montant_ht);
        const montantTVAAvoir = Math.abs(extractedData.montant_tva);
        const montantTTCAvoir = Math.abs(extractedData.montant_ttc);
        
        accountEntries.push(
          { piece, accountType: 'fournisseur', compte: '4010FD', montant: montantTTCAvoir.toFixed(2), sens: 'D' },
          { piece, accountType: 'charge', compte: '601000', montant: montantHTAvoir.toFixed(2), sens: 'C' },
          { piece, accountType: 'tva', compte: '445667', montant: montantTVAAvoir.toFixed(2), sens: 'C' }
        );
      } else if (isIntracomm) {
        const tvaIntra = (extractedData.montant_ht * 0.20).toFixed(2);
        accountEntries.push(
          { piece, accountType: 'charge', compte: '601100', montant: extractedData.montant_ht.toFixed(2), sens: 'D' },
          { piece, accountType: 'tva', compte: '445668', montant: tvaIntra, sens: 'D' },
          { piece, accountType: 'tva', compte: '445200', montant: tvaIntra, sens: 'C' },
          { piece, accountType: 'fournisseur', compte: '4010FD', montant: extractedData.montant_ht.toFixed(2), sens: 'C' }
        );
      } else {
        accountEntries.push(
          { piece, accountType: 'charge', compte: '606110', montant: extractedData.montant_ht.toFixed(2), sens: 'D' },
          { piece, accountType: 'tva', compte: '445667', montant: extractedData.montant_tva.toFixed(2), sens: 'D' },
          { piece, accountType: 'fournisseur', compte: '4010FD', montant: extractedData.montant_ttc.toFixed(2), sens: 'C' }
        );
      }

      const tbody = document.getElementById('entriesTable');
      tbody.innerHTML = accountEntries.map((e, i) => `
        <tr class="border-t hover:bg-gray-50">
          <td class="px-4 py-2 font-mono text-sm">${e.piece}</td>
          <td class="px-4 py-2">
            <span class="px-2 py-1 rounded text-xs font-medium ${
              e.accountType === 'charge' ? 'bg-blue-100 text-blue-700' :
              e.accountType === 'fournisseur' ? 'bg-purple-100 text-purple-700' :
              'bg-amber-100 text-amber-700'
            }">${e.accountType}</span>
          </td>
          <td class="px-4 py-2">
            <select id="account-select-${i}" onchange="updateAccountAndRefresh(${i}, this.value)" class="border rounded px-2 py-1 w-full text-sm ${!e.compte ? 'border-red-300 bg-red-50' : 'border-gray-300'}">
              <option value="">-- SÃ©lectionner --</option>
              ${getAccountsByType(e.accountType).map(a => 
                `<option value="${a.code}" ${e.compte === a.code ? 'selected' : ''}>${a.code} - ${a.label}</option>`
              ).join('')}
            </select>
          </td>
          <td class="px-4 py-2 font-mono">${e.montant} â‚¬</td>
          <td class="px-4 py-2">
            <span class="px-2 py-1 rounded text-xs font-semibold ${e.sens === 'D' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
              ${e.sens}
            </span>
          </td>
        </tr>
      `).join('');
    }

function exportToSage() {
      // ğŸ†• VÃ©rifications complÃ¨tes
      if (!extractedData) {
        alert('âŒ Aucune donnÃ©e Ã  exporter');
        return;
      }
      
      const hasEmpty = accountEntries.some(e => !e.compte);
      if (hasEmpty) {
        alert('âš ï¸ Tous les comptes doivent Ãªtre renseignÃ©s avant export');
        return;
      }
      
      const code = document.getElementById('codeJournal').value;
      if (!code || code.length !== 2) {
        alert('âš ï¸ Le code journal doit contenir exactement 2 caractÃ¨res');
        return;
      }
      
      // ğŸ†• VÃ©rification Ã©quilibre dÃ©bit/crÃ©dit
      const totalDebit = accountEntries.filter(e => e.sens === 'D').reduce((sum, e) => sum + parseFloat(e.montant), 0);
      const totalCredit = accountEntries.filter(e => e.sens === 'C').reduce((sum, e) => sum + parseFloat(e.montant), 0);
      
      if (Math.abs(totalDebit - totalCredit) > 0.01) {
        alert(`âš ï¸ Les Ã©critures ne sont pas Ã©quilibrÃ©es !\n\nDÃ©bit: ${totalDebit.toFixed(2)} â‚¬\nCrÃ©dit: ${totalCredit.toFixed(2)} â‚¬\n\nDiffÃ©rence: ${Math.abs(totalDebit - totalCredit).toFixed(2)} â‚¬`);
        return;
      }
      
      const numFacture = extractedData.numero_facture;
      const date = extractedData.date;
      
      const removeAccents = (str) => str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      
      let output = '';
       accountEntries.forEach(e => {
        // ğŸ†• EXTRACTION REFERENCE PDR-XX-XXXX
        const pdrMatch = extractedData.description ? extractedData.description.match(/PDR-\d{2}-\d{4}/i) : null;
        const referencePDR = pdrMatch ? pdrMatch[0].toUpperCase() : null;
        
        let libelle = '';
        if (referencePDR) {
          libelle = removeAccents(referencePDR + ' ' + extractedData.fournisseur);
        } else if (extractedData.reference_interne) {
          libelle = removeAccents(extractedData.reference_interne + ' ' + extractedData.fournisseur);
        } else {
          libelle = removeAccents(extractedData.fournisseur);
        }
        libelle = libelle.substring(0, 25);
        
        let description = '';
        if (referencePDR) {
          description = removeAccents(referencePDR + ' ' + extractedData.fournisseur);
        } else if (extractedData.reference_interne) {
          description = removeAccents(extractedData.reference_interne + ' ' + extractedData.fournisseur);
        } else {
          description = removeAccents(
            e.accountType === 'charge' ? 
              (extractedData.description || 'Achat') : 
              extractedData.fournisseur
          );
        }
        description = description.substring(0, 34);
        
        const montantArrondi = Math.round(parseFloat(e.montant) * 100) / 100;
        const montantCentimes = Math.round(montantArrondi * 100);
        
        const line = 
          numFacture.toString().padStart(5, ' ') + ',' +
          code + ',' +
          date + ',' +
          ''.padEnd(20, ' ') + ',' +
          e.compte.padEnd(11, ' ') + ',' +
          libelle.padEnd(25, ' ') + ',' +
          montantCentimes.toString().padStart(13, ' ') + ',' +
          e.sens + ',' +
          ''.padEnd(12, ' ') + ',' +
          ''.padEnd(6, ' ') + ',' +
          description.padEnd(34, ' ') + ',' +
          '\r\n';
        
        output += line;
      });

      const blob = new Blob([output], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ExportFile_${removeAccents(extractedData.fournisseur).replace(/[^a-zA-Z0-9]/g, '_')}_${date}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      // ğŸ†• Message dÃ©taillÃ©
      alert(`âœ… Export N2F rÃ©ussi !\n\nFournisseur: ${extractedData.fournisseur}\nFacture: ${numFacture}\nMontant: ${extractedData.montant_ttc.toFixed(2)} â‚¬\n\n${accountEntries.length} Ã©critures gÃ©nÃ©rÃ©es`);
    }
  </script>
</body>
</html>
